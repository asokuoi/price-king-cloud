{% extends "admin/base.html" %}

{% block content %}
<style>
    /* Admin UI å„ªåŒ– */
    .admin-header-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-left: 5px solid #0d6efd;
    }
    .search-group {
        position: relative;
        min-width: 250px;
    }
    .search-group .bi-search {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
    }
    .admin-search-input {
        padding-left: 35px;
        border-radius: 20px;
        border: 1px solid #ced4da;
    }
    .spec-badge {
        font-size: 0.75rem;
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="fw-bold mb-0">ğŸ“¦ å•†å“ç®¡ç†</h2>
        <small class="text-muted">ç®¡ç†æ‰€æœ‰ä¸Šæ¶å•†å“ã€è¦æ ¼èˆ‡åƒ¹æ ¼åƒæ•¸</small>
    </div>
    <button class="btn btn-success rounded-pill px-4 shadow-sm fw-bold" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-lg me-1"></i> æ–°å¢å•†å“
    </button>
</div>

<div class="card shadow-sm mb-4 border-0 admin-header-card">
    <div class="card-body py-3">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            
            <div class="d-flex flex-column">
                <div class="text-muted small fw-bold mb-2">
                    <i class="bi bi-funnel-fill me-1"></i> åˆ†é¡ç¯©é¸ï¼š
                </div>
                <div class="d-flex flex-wrap gap-2" id="category-filters">
                    <button class="btn btn-sm btn-dark active rounded-pill px-3" onclick="filterTable('all', this)">å…¨éƒ¨</button>
                    {% for cat in options['category'] %}
                    <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="filterTable('{{ cat.name }}', this)">
                        {{ cat.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div class="search-group">
                <i class="bi bi-search"></i>
                <input type="text" id="tableSearchInput" class="form-control admin-search-input" 
                       placeholder="æœå°‹å“åã€è¦æ ¼æˆ–ID..." onkeyup="performSearch()">
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="products-table">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4" style="width: 80px;">ID</th>
                        <th style="width: 120px;">åˆ†é¡</th>
                        <th>å“å (Name)</th>
                        <th>è¦æ ¼ / æè³ª</th>
                        <th>CPå€¼åƒæ•¸</th>
                        <th>ç‹€æ…‹</th>
                        <th class="text-end pe-4" style="width: 150px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="product-tbody">
                    {% for p in products %}
                    <tr class="product-row" 
                        data-category="{{ p.category }}" 
                        data-name="{{ p.name }}" 
                        data-material="{{ p.material or '' }}" 
                        data-spec="{{ p.spec or '' }}"
                        data-id="{{ p.id }}">
                        
                        <td class="ps-4 text-muted font-monospace">#{{ p.id }}</td>
                        <td><span class="badge bg-secondary bg-opacity-10 text-secondary border">{{ p.category }}</span></td>
                        <td class="fw-bold text-dark fs-6">{{ p.name }}</td>
                        <td>
                            {% if p.spec %}<span class="spec-badge me-1">{{ p.spec }}</span>{% endif %}
                            {% if p.material %}<span class="spec-badge text-primary border-primary bg-primary bg-opacity-10">{{ p.material }}</span>{% endif %}
                        </td>
                        <td class="small">
                            {% if p.capacity and p.capacity > 0 %}
                                <span class="text-success fw-bold">{{ p.capacity }}</span> 
                                <span class="text-muted">{{ p.unit }}</span>
                            {% else %}
                                <span class="text-warning small"><i class="bi bi-exclamation-circle"></i> æœªè¨­å®š</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if p.status == 1 %}
                            <span class="badge bg-success rounded-pill">ä¸Šæ¶ä¸­</span>
                            {% else %}
                            <span class="badge bg-danger rounded-pill">å·²ä¸‹æ¶</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-primary me-1 rounded-circle" style="width:32px;height:32px;padding:0;" 
                                    title="ç·¨è¼¯"
                                    onclick="editProduct('{{ p.id }}', '{{ p.name }}', '{{ p.spec }}', '{{ p.material }}', '{{ p.category }}', '{{ p.keywords }}', '{{ p.capacity }}', '{{ p.unit }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            
                            <form action="/admin/products/toggle" method="POST" class="d-inline">
                                <input type="hidden" name="product_id" value="{{ p.id }}">
                                <input type="hidden" name="current_status" value="{{ p.status }}">
                                <button type="submit" class="btn btn-sm {% if p.status == 1 %}btn-outline-warning{% else %}btn-outline-success{% endif %} me-1 rounded-circle" 
                                        style="width:32px;height:32px;padding:0;"
                                        title="{% if p.status == 1 %}ä¸‹æ¶{% else %}ä¸Šæ¶{% endif %}">
                                    <i class="bi {% if p.status == 1 %}bi-eye-slash{% else %}bi-eye{% endif %}"></i>
                                </button>
                            </form>
                            
                            <form action="/admin/products/delete" method="POST" class="d-inline" onsubmit="return confirm('âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å—ï¼Ÿ\n\næ³¨æ„ï¼šå¦‚æœè©²å•†å“æœ‰æ­·å²ç´€éŒ„ï¼Œå¯èƒ½æœƒå°è‡´è³‡æ–™ä¸ä¸€è‡´ã€‚');">
                                <input type="hidden" name="product_id" value="{{ p.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger rounded-circle" style="width:32px;height:32px;padding:0;" title="æ°¸ä¹…åˆªé™¤">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="no-result-msg" class="text-center py-5 text-muted d-none">
                <i class="bi bi-search display-6 mb-3"></i>
                <p>æ‰¾ä¸åˆ°ç¬¦åˆçš„å•†å“</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle"></i> æ–°å¢å•†å“</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/products/add" method="POST">
                <div class="modal-body bg-light">
                    <div class="card p-3 border-0 shadow-sm">
                        <div class="mb-3">
                            <label class="form-label text-primary fw-bold">1. å•†å“åˆ†é¡</label>
                            <select name="category" class="form-select" required>
                                <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
                                {% for cat in options['category'] %}<option value="{{ cat.name }}">{{ cat.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">2. å•†å“åç¨±</label>
                            <input type="text" name="name" class="form-control fw-bold" placeholder="è«‹è¼¸å…¥å®Œæ•´å“å" required>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label text-success fw-bold">3. è¦æ ¼</label>
                                <select name="spec" class="form-select">
                                    <option value="">-- ç„¡ --</option>
                                    {% for s in options['spec'] %}<option value="{{ s.name }}">{{ s.name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label text-warning fw-bold">4. æè³ª</label>
                                <select name="material" class="form-select">
                                    <option value="">-- ç„¡ --</option>
                                    {% for m in options['material'] %}<option value="{{ m.name }}">{{ m.name }}</option>{% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="p-3 bg-white rounded mb-3 border dashed-border">
                            <label class="form-label fw-bold text-dark mb-2 small"><i class="bi bi-calculator"></i> CPå€¼è¨ˆç®—åƒæ•¸</label>
                            <div class="row g-2">
                                <div class="col-8">
                                    <input type="number" name="capacity" class="form-control" placeholder="å®¹é‡æ•¸å€¼ (ä¾‹: 330)" step="0.1" required>
                                </div>
                                <div class="col-4">
                                    <select name="unit" class="form-select" required>
                                        <option value="" disabled selected>å–®ä½</option>
                                        {% for u in options['unit'] %}<option value="{{ u.name }}">{{ u.name }}</option>{% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-0">
                            <label class="form-label small text-muted">æœå°‹é—œéµå­— (é¸å¡«)</label>
                            <input type="text" name="keywords" class="form-control form-control-sm" placeholder="ä¾‹: å°å•¤ ç”Ÿå•¤">
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success px-4 fw-bold">ç¢ºèªæ–°å¢</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square"></i> ç·¨è¼¯å•†å“</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/products/edit" method="POST">
                <input type="hidden" name="product_id" id="edit_id">
                <div class="modal-body bg-light">
                    <div class="card p-3 border-0 shadow-sm">
                        <div class="mb-3">
                            <label class="form-label text-primary fw-bold">åˆ†é¡</label>
                            <select name="category" id="edit_category" class="form-select" required>
                                {% for cat in options['category'] %}<option value="{{ cat.name }}">{{ cat.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">å•†å“åç¨±</label>
                            <input type="text" name="name" id="edit_name" class="form-control fw-bold" required>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label text-success fw-bold">è¦æ ¼</label>
                                <select name="spec" id="edit_spec" class="form-select">
                                    <option value="">-- ç„¡ --</option>
                                    {% for s in options['spec'] %}<option value="{{ s.name }}">{{ s.name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label text-warning fw-bold">æè³ª</label>
                                <select name="material" id="edit_material" class="form-select">
                                    <option value="">-- ç„¡ --</option>
                                    {% for m in options['material'] %}<option value="{{ m.name }}">{{ m.name }}</option>{% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="p-3 bg-white rounded mb-3 border">
                            <label class="form-label fw-bold text-dark mb-2 small">CPå€¼è¨­å®š</label>
                            <div class="row g-2">
                                <div class="col-8"><input type="number" name="capacity" id="edit_capacity" class="form-control" step="0.1"></div>
                                <div class="col-4">
                                    <select name="unit" id="edit_unit" class="form-select">
                                        {% for u in options['unit'] %}<option value="{{ u.name }}">{{ u.name }}</option>{% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-0"><label class="form-label small text-muted">é—œéµå­—</label><input type="text" name="keywords" id="edit_keywords" class="form-control form-control-sm"></div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ğŸ”¥ æ ¸å¿ƒæ’åºé‚è¼¯ï¼šå“å -> æè³ª -> è¦æ ¼
function sortRows() {
    const tbody = document.getElementById('product-tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        // 1. å…ˆæ¯”å° å“å (ä¸­æ–‡ç­†ç•«/è‹±æ–‡é †åº)
        const nameA = a.dataset.name || '';
        const nameB = b.dataset.name || '';
        const nameCompare = nameA.localeCompare(nameB, 'zh-Hant');
        if (nameCompare !== 0) return nameCompare;

        // 2. å¦‚æœå“åä¸€æ¨£ï¼Œæ¯”å° æè³ª (é‹ç½ vs ç»ç’ƒ)
        const matA = a.dataset.material || '';
        const matB = b.dataset.material || '';
        const matCompare = matA.localeCompare(matB, 'zh-Hant');
        if (matCompare !== 0) return matCompare;

        // 3. å¦‚æœæè³ªä¹Ÿä¸€æ¨£ï¼Œæ¯”å° è¦æ ¼ (å˜—è©¦è½‰æˆæ•¸å­—æ¯”å¤§å°)
        const specA = parseFloat(a.dataset.spec) || 0;
        const specB = parseFloat(b.dataset.spec) || 0;
        return specA - specB;
    });

    // é‡æ–°æ’å…¥æ’åºå¾Œçš„ Rows
    rows.forEach(row => tbody.appendChild(row));
}

// æœå°‹ + ç¯©é¸é‚è¼¯
function performSearch() {
    const keyword = document.getElementById('tableSearchInput').value.trim().toLowerCase();
    // å–å¾—ç•¶å‰æ´»èºçš„åˆ†é¡ (å¾æŒ‰éˆ•ç‹€æ…‹åˆ¤æ–·)
    const activeBtn = document.querySelector('#category-filters button.active');
    const activeCategory = activeBtn ? activeBtn.textContent.trim() : 'å…¨éƒ¨é¡¯ç¤º'; // ä¿®æ­£æŒ‰éˆ•æ–‡å­—å°æ‡‰
    
    // å‘¼å«ä¸»éæ¿¾å™¨ï¼Œå‚³å…¥ç¾åœ¨çš„åˆ†é¡ï¼Œè®“æœå°‹æ¡†ä¹Ÿèƒ½åœ¨åˆ†é¡ä¸‹é‹ä½œ
    // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘ç°¡åŒ–é‚è¼¯ï¼Œè®“ filterTable è² è²¬æ‰€æœ‰é¡¯ç¤ºéš±è—
    filterTable(activeCategory === 'å…¨éƒ¨' || activeCategory === 'å…¨éƒ¨é¡¯ç¤º' ? 'all' : activeCategory, activeBtn, true);
}

function filterTable(category, btn, isFromSearch = false) {
    const keyword = document.getElementById('tableSearchInput').value.trim().toLowerCase();
    const rows = document.querySelectorAll('#products-table tbody tr');
    let hasResult = false;

    // æ›´æ–°æŒ‰éˆ•æ¨£å¼ (å¦‚æœæ˜¯æœå°‹è§¸ç™¼çš„ï¼Œä¸æ”¹è®ŠæŒ‰éˆ•ç‹€æ…‹)
    if (!isFromSearch && btn) {
        localStorage.setItem('admin_product_filter', category);
        document.querySelectorAll('#category-filters button').forEach(b => { 
            b.classList.remove('btn-dark', 'active'); 
            b.classList.add('btn-outline-secondary'); 
        });
        btn.classList.remove('btn-outline-secondary'); 
        btn.classList.add('btn-dark', 'active');
    }

    rows.forEach(row => { 
        // 1. æª¢æŸ¥åˆ†é¡
        const matchCat = (category === 'all' || row.dataset.category === category);
        
        // 2. æª¢æŸ¥æœå°‹é—œéµå­— (æœå°‹ ID, å“å, è¦æ ¼, æè³ª)
        const content = (row.dataset.id + row.dataset.name + row.dataset.spec + row.dataset.material).toLowerCase();
        const matchKey = !keyword || content.includes(keyword);

        if (matchCat && matchKey) {
            row.style.display = '';
            hasResult = true;
        } else {
            row.style.display = 'none';
        }
    });

    // é¡¯ç¤º/éš±è— ç„¡çµæœæç¤º
    const msg = document.getElementById('no-result-msg');
    if (msg) msg.classList.toggle('d-none', hasResult);
}

function editProduct(id, name, spec, material, category, keywords, capacity, unit) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_category').value = category;
    document.getElementById('edit_keywords').value = (keywords && keywords!='None') ? keywords : '';
    document.getElementById('edit_capacity').value = (capacity && capacity!='None') ? capacity : 0;
    document.getElementById('edit_spec').value = (spec && spec!='None') ? spec : '';
    document.getElementById('edit_material').value = (material && material!='None') ? material : '';
    document.getElementById('edit_unit').value = (unit && unit!='None') ? unit : '';
    new bootstrap.Modal(document.getElementById('editProductModal')).show();
}

window.addEventListener('DOMContentLoaded', () => {
    // 1. è‡ªå‹•æ’åº (é€™æ˜¯é‡é»!)
    sortRows();

    // 2. æ¢å¾©ä¸Šæ¬¡çš„åˆ†é¡ç¯©é¸
    const saved = localStorage.getItem('admin_product_filter');
    if(saved) {
        // æ¨¡ç³Šæ¯”å°æŒ‰éˆ•æ–‡å­— (å› ç‚ºæœ‰æ™‚å€™å¯èƒ½æœ‰ç©ºæ ¼)
        const btns = Array.from(document.querySelectorAll('#category-filters button'));
        const btn = btns.find(b => b.textContent.trim() === saved) || btns[0];
        filterTable(saved, btn);
    }
});
</script>
{% endblock %}