{% extends "admin/base.html" %}

{% block content %}

<style>
    :root { --primary-bg: #f8f9fc; --card-border: #e3e6f0; --text-dark: #3a3b45; --text-muted: #858796; }
    body { background-color: var(--primary-bg); font-family: 'Nunito', system-ui, sans-serif; }

    /* é ‚éƒ¨æ¨™é¡Œå€ */
    .page-header { background: white; padding: 20px 25px; border-radius: 15px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }

    /* æ•¸æ“šè¡¨æ ¼å¡ç‰‡ */
    .dashboard-card { background: white; border: none; border-radius: 15px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.08); overflow: hidden; }

    /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
    .table thead th { background-color: #f8f9fc; color: #4e73df; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; border-bottom: 2px solid #e3e6f0; padding: 15px; vertical-align: middle;}
    .table tbody td { padding: 15px; vertical-align: middle; color: #5a5c69; }
    .table-hover tbody tr:hover { background-color: #f8f9fc; transition: 0.2s; }

    /* ğŸ”¥ æ¬„ä½å¯¬åº¦è¨­å®š */
    .col-fixed-100 { width: 110px; text-align: center; } /* çµ¦æ ¸éŠ·ç”¨ */
    .col-history { min-width: 160px; text-align: center; } /* çµ¦æ­·å²ç¸¾æ•ˆç”¨ï¼Œç¨å¾®å¯¬ä¸€é» */

    /* è™›æ“¬é ­åƒ */
    .avatar-circle { width: 40px; height: 40px; background-color: #4e73df; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; margin-right: 12px; position: relative; flex-shrink: 0; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; position: absolute; bottom: 0; right: 0; }

    /* æ•¸æ“šè† å›Š (é€šç”¨) */
    .data-pill { 
        display: inline-flex; flex-direction: column; align-items: center; justify-content: center; 
        padding: 5px 0; border-radius: 8px; background: #f8f9fc; 
        width: 100%; min-width: 60px;
    }
    .data-pill .label { font-size: 0.65rem; color: #a0a0a0; text-transform: uppercase; margin-bottom: 2px; }
    .data-pill .value { font-weight: 800; font-size: 1rem; color: #5a5c69; }

    /* å¾…æ ¸éŠ·å¼·èª¿ (æ·±é»ƒè‰²) */
    .unpaid-pill { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .unpaid-pill .label { color: #856404; opacity: 0.7; }
    .unpaid-pill .value { color: #856404; }
    
    /* éŒ¢åŒ…é‡‘é¡ */
    .wallet-amount { font-family: 'Consolas', monospace; font-weight: 700; font-size: 1.2rem; }
    .text-money { color: #e74a3b; }

    /* æ“ä½œæŒ‰éˆ•ç¾¤ */
    .action-btn-group { display: flex; align-items: center; justify-content: flex-end; gap: 5px; }
    .action-btn-group .btn { border-radius: 50px; width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem; }
    .action-btn-group .btn-payout { width: auto; padding: 0 12px; height: 32px; }
</style>

<div class="page-header">
    <div>
        <h4 class="mb-1 fw-bold text-dark"><i class="bi bi-people-fill text-primary me-2"></i>å“¡å·¥è–ªè³‡ç®¡ç†</h4>
        <div class="text-muted small">ç¸¾æ•ˆç›£æ§ / çé‡‘æ ¸ç®—ä¸­å¿ƒ</div>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-light text-secondary border fw-bold" onclick="location.reload()">
            <i class="bi bi-arrow-repeat"></i> åˆ·æ–°
        </button>
        <button class="btn btn-primary fw-bold px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#addStaffModal">
            <i class="bi bi-plus-lg"></i> æ–°å¢å“¡å·¥
        </button>
    </div>
</div>

<div class="dashboard-card">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th class="ps-4">å“¡å·¥è³‡è¨Š</th>
                    <th>æ‰€å±¬å–®ä½</th>
                    
                    <th class="col-history">æ­·å²ç¸¾æ•ˆ (ç¸½/æœ‰æ•ˆ)</th>
                    
                    <th class="col-fixed-100">å·²æ ¸éŠ·</th>
                    
                    <th class="col-fixed-100">å¾…æ ¸éŠ·</th>
                    
                    <th class="text-end">æ‡‰ç™¼çé‡‘</th>
                    <th class="text-end pe-4">ç®¡ç†æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for s in staff_list %}
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle" style="background-color: {{ 'gray' if s.status == 0 else '#4e73df' }}">
                                {{ s.name[0] }}
                                <div class="status-dot" style="background-color: {{ '#1cc88a' if s.status == 1 else '#e74a3b' }}"></div>
                            </div>
                            <div>
                                <div class="fw-bold text-dark fs-6">{{ s.name }}</div>
                                <div class="text-secondary fw-bold font-monospace mt-1" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                    <i class="bi bi-person-badge me-1"></i>{{ s.line_id }}
                                </div>
                            </div>
                        </div>
                    </td>

                    <td>
                        {% if s.chain_name %}
                            <div class="badge bg-light text-dark border px-3 py-2 rounded-pill">
                                <i class="bi bi-shop me-1"></i> {{ s.chain_name }}
                            </div>
                        {% else %}
                            <span class="badge bg-secondary rounded-pill">è‡ªç”±äºº</span>
                        {% endif %}
                        <div class="small text-muted mt-1 ms-2">Lv.{{ s.level }}</div>
                    </td>

                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            <div class="data-pill">
                                <span class="label">ç¸½æ›´æ–°</span>
                                <span class="value">{{ s.total_logs }}</span>
                            </div>
                            <div class="data-pill">
                                <span class="label">æœ‰æ•ˆ</span>
                                <span class="value text-primary">{{ s.valid_logs }}</span>
                            </div>
                        </div>
                    </td>

                    <td class="text-center">
                        <div class="data-pill" style="background-color: #e8f5e9;">
                            <span class="label text-success">å·²çµæ¸…</span>
                            <span class="value text-success fw-bold">{{ s.paid_logs }}</span>
                        </div>
                    </td>

                    <td class="text-center">
                        {% if s.unpaid_logs > 0 %}
                            <div class="data-pill unpaid-pill shadow-sm">
                                <span class="label">å¾…è™•ç†</span>
                                <span class="value">{{ s.unpaid_logs }}</span>
                            </div>
                        {% else %}
                            <span class="text-muted opacity-50 small"><i class="bi bi-check-circle-fill"></i> ç„¡</span>
                        {% endif %}
                    </td>

                    <td class="text-end">
                        {% if s.calc_wallet > 0 %}
                            <div class="wallet-amount text-money">${{ s.calc_wallet }}</div>
                        {% else %}
                            <div class="wallet-amount text-muted opacity-25">$0</div>
                        {% endif %}
                    </td>

                    <td class="text-end pe-4">
                        <div class="action-btn-group">
                            <button class="btn btn-outline-secondary" 
                                    onclick="editStaff('{{ s.line_id }}', '{{ s.name }}', '{{ s.level }}', '{{ s.chain_id }}', '{{ s.status }}')"
                                    title="ç·¨è¼¯">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            
                            {% if s.calc_wallet > 0 %}
                            <form action="/admin/staff/payout" method="POST" class="d-inline" 
                                  onsubmit="return confirm('ğŸ’° æ ¸éŠ·ç¢ºèªï¼š\n\nå“¡å·¥ï¼š{{ s.name }}\né‡‘é¡ï¼š${{ s.calc_wallet }}\nç­†æ•¸ï¼š{{ s.unpaid_logs }} ç­†\n\nç¢ºå®šæ ¸éŠ·ä¸¦æ­¸é›¶å—ï¼Ÿ');">
                                <input type="hidden" name="line_id" value="{{ s.line_id }}">
                                <button type="submit" class="btn btn-success shadow-sm btn-payout">
                                    <i class="bi bi-cash-stack me-1"></i> æ ¸éŠ·
                                </button>
                            </form>
                            {% else %}
                                <button class="btn btn-light text-muted border btn-payout" disabled>
                                    <i class="bi bi-check2 me-1"></i> çµæ¸…
                                </button>
                            {% endif %}
                            
                            <form action="/admin/staff/delete" method="POST" class="d-inline" 
                                  onsubmit="return confirm('âš ï¸ ç¢ºå®šåˆªé™¤æ­¤å“¡å·¥å—ï¼Ÿ');">
                                <input type="hidden" name="line_id" value="{{ s.line_id }}">
                                <button type="submit" class="btn btn-outline-danger border-0" title="åˆªé™¤">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                
                {% if not staff_list %}
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">
                        <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="64" class="mb-3 opacity-50">
                        <p>ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-person-plus"></i> æ–°å¢å“¡å·¥</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/staff/add" method="POST">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary">LINE User ID</label>
                        <input type="text" name="line_id" class="form-control" placeholder="Uxxxxxxxx..." required>
                        <div class="form-text">è«‹è²¼ä¸Šå¾ LINE Developers å–å¾—çš„ User ID</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary">çœŸå¯¦å§“å</label>
                        <input type="text" name="name" class="form-control" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">æ¬Šé™ç­‰ç´š</label>
                            <select name="level" class="form-select">
                                <option value="1">Lv.1 åº—å“¡ (åŸºæœ¬)</option>
                                <option value="2">Lv.2 åº—é•· (é€²éš)</option>
                                <option value="3">Lv.3 ç£å° (é«˜éš)</option>
                                <option value="9">Lv.9 ç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">ç¶å®šé€šè·¯</label>
                            <select name="chain_id" class="form-select">
                                <option value="-1">-- è‡ªç”±äºº (ä¸ç¶å®š) --</option>
                                {% for c in chains %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">ç¢ºèªæ–°å¢</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="editStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square"></i> ç·¨è¼¯å“¡å·¥è³‡æ–™</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/staff/edit" method="POST">
                <div class="modal-body p-4">
                    <input type="hidden" name="original_line_id" id="edit_original_line_id">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary">LINE User ID (å¯ä¿®æ”¹)</label>
                        <input type="text" name="new_line_id" id="edit_new_line_id" class="form-control font-monospace" required>
                        <div class="form-text text-danger"><i class="bi bi-exclamation-circle"></i> æ³¨æ„ï¼šä¿®æ”¹ ID æœƒä¸€ä½µè½‰ç§»è©²å“¡å·¥çš„æ­·å²ç¸¾æ•ˆã€‚</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary">å§“å</label>
                        <input type="text" name="name" id="edit_name" class="form-control" required>
                    </div>

                    <div class="mb-3 p-3 bg-light rounded border">
                        <label class="form-label fw-bold text-secondary d-block">å¸³è™Ÿç‹€æ…‹</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="status" id="status_active" value="1">
                            <label class="btn btn-outline-success" for="status_active"><i class="bi bi-check-circle"></i> æ­£å¸¸å•Ÿç”¨</label>
                            
                            <input type="radio" class="btn-check" name="status" id="status_banned" value="0">
                            <label class="btn btn-outline-danger" for="status_banned"><i class="bi bi-slash-circle"></i> åœæ¬Šå°é–</label>
                        </div>
                        <div class="form-text mt-2">å¦‚å“¡å·¥é›¢è·æˆ–é•è¦ï¼Œè«‹é¸æ“‡åœæ¬Šã€‚</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">æ¬Šé™ç­‰ç´š</label>
                            <select name="level" id="edit_level" class="form-select">
                                <option value="1">Lv.1 åº—å“¡</option>
                                <option value="2">Lv.2 åº—é•·</option>
                                <option value="3">Lv.3 ç£å°</option>
                                <option value="9">Lv.9 Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">ç¶å®šé€šè·¯</label>
                            <select name="chain_id" id="edit_chain_id" class="form-select">
                                <option value="-1">-- è‡ªç”±äºº --</option>
                                {% for c in chains %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-dark px-4 fw-bold">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function editStaff(lid, name, lvl, cid, status) {
        document.getElementById('edit_original_line_id').value = lid;
        document.getElementById('edit_new_line_id').value = lid; 
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_level').value = lvl;
        document.getElementById('edit_chain_id').value = (cid && cid != 'None') ? cid : -1;
        
        if(status == 0) {
            document.getElementById('status_banned').checked = true;
        } else {
            document.getElementById('status_active').checked = true;
        }
        
        new bootstrap.Modal(document.getElementById('editStaffModal')).show();
    }
</script>
{% endblock %}