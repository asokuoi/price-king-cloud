<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒ¹æ ¼ç‹ å“¡å·¥ç›¤é» V5.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f6; padding-bottom: 80px; }
        
        /* Header Wrapper */
        .audit-header-wrapper {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1050;
            background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* è³‡è¨Šåˆ— */
        .info-bar {
            padding: 10px 15px; background: #fff;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .staff-badge { background: #e9ecef; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; color: #495057; }
        .chain-title { font-weight: 800; font-size: 1.1rem; color: #212529; display: flex; align-items: center; gap: 6px; }
        .wallet-pill { background: #d1e7dd; color: #0f5132; padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }

        /* æœå°‹åˆ— */
        .search-bar-row { padding: 10px 15px; background: #fff; }
        .search-input { border-radius: 50px; background: #f1f3f5; border: none; height: 40px; font-weight: 500; padding-left: 40px; width: 100%; }
        .search-icon { position: absolute; left: 30px; top: 50%; transform: translateY(-50%); color: #adb5bd; }

        /* åˆ†é¡éæ¿¾ */
        .filter-bar { 
            white-space: nowrap; overflow-x: auto; padding: 0 15px 10px 15px; 
            background: #fff; display: flex; gap: 8px; scrollbar-width: none;
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip { 
            display: inline-flex; align-items: center; justify-content: center;
            padding: 6px 16px; border-radius: 20px; 
            background: #fff; color: #495057; border: 1px solid #e9ecef;
            font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s;
            flex-shrink: 0;
        }
        .filter-chip.active { background: #212529; color: white; border-color: #212529; }

        #main-content { margin-top: 160px; }

        /* å•†å“å¡ç‰‡ (åŸºæœ¬æ¨£å¼) */
        .product-card { 
            background: #fff; border-radius: 12px; margin-bottom: 12px; 
            border: 2.5px solid #ffb3c1; /* é è¨­ç²‰è‰²æ¡† (æœªç›¤é») */
            box-shadow: 0 4px 8px rgba(0,0,0,0.03);
            padding: 15px; position: relative;
            transition: all 0.2s ease;
        }

        /* ğŸ”¥ å·²ç›¤é»æ¨£å¼ (ç¶ è‰²) */
        .product-card.audited {
            border: 2.5px solid #198754 !important; /* ç¶ è‰²é‚Šæ¡† */
            background-color: #f0fdf4 !important;    /* æ·ºç¶ èƒŒæ™¯ */
        }

        /* ğŸ”¥ å³ä¸Šè§’ç¶ è‰²å‹¾å‹¾ */
        .audited-badge {
            position: absolute; top: -10px; right: -10px;
            background-color: #198754; color: white;
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            border: 2px solid white;
        }

        /* ğŸ”¥ å³ä¸‹è§’ç¶“æ‰‹äººæ¨™ç±¤ */
        .audited-by-tag {
            position: absolute; bottom: 10px; right: 10px;
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
            font-size: 0.7rem; font-weight: 700;
            padding: 2px 8px; border-radius: 6px;
        }

        .p-name { font-weight: 900; font-size: 1.05rem; color: #000; margin-bottom: 4px; }
        .p-meta { font-size: 0.85rem; color: #6c757d; font-weight: 500; }
        .p-spec-tag { background: #f8f9fa; padding: 2px 6px; border-radius: 4px; border: 1px solid #dee2e6; margin-right: 4px; font-size: 0.75rem;}
        
        .p-action-row { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            margin-top: 10px; border-top: 1px dashed #f0f0f0; padding-top: 10px;
        }
        .p-price-display { font-weight: 800; font-size: 1.2rem; color: #198754; }
        .p-promo-tag { background: #fff8c4; color: #b08d00; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 6px; }
        
        .btn-edit-action { 
            color: #0d6efd; font-weight: 700; font-size: 0.9rem; text-decoration: none; 
            display: flex; align-items: center; gap: 4px; cursor: pointer;
        }
        .btn-edit-action:active { opacity: 0.7; }

        /* Modal */
        .modal-bottom { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); padding: 25px 20px; 
            z-index: 2000; transform: translateY(100%); transition: transform 0.3s;
        }
        .modal-bottom.show { transform: translateY(0); }
        .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
        .backdrop.show { display: block; }

        .current-promo-warning { color: #dc3545; font-weight: 700; font-size: 0.85rem; margin-bottom: 4px; }
        #loading-overlay { position: fixed; inset:0; background:white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .auth-card { background: white; border-radius: 15px; padding: 30px 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); max-width: 320px; margin: 100px auto; text-align: center; }
        .auth-id-box { background: #f1f3f5; padding: 10px; border-radius: 8px; font-family: monospace; color: #495057; margin-top: 15px; word-break: break-all; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-3 small text-muted fw-bold">ç³»çµ±é€£ç·šä¸­...</div>
    </div>

    <div id="main-ui" style="display:none;">
        <div class="audit-header-wrapper">
            <div class="info-bar">
                <div class="d-flex align-items-center gap-2">
                    <span class="staff-badge" id="staff-name">è¨ªå®¢</span>
                    <div class="chain-title" id="chain-display">
                        <i class="bi bi-shop"></i> <span id="chain-text">--</span>
                        <select id="chain-selector" class="form-select form-select-sm d-none" style="width: auto;"></select>
                    </div>
                </div>
                <div class="wallet-pill" id="wallet-box" style="display:none;">
                    ğŸ’° $<span id="wallet-amt">0</span>
                </div>
            </div>

            <div class="search-bar-row position-relative">
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥å•†å“é—œéµå­— (ä¾‹: é‡‘ç‰Œ)" onkeyup="filterProducts()">
            </div>

            <div class="filter-bar" id="category-filter"></div>
        </div>

        <div class="container" id="main-content">
            <div id="product-list"></div>
            <div id="empty-msg" class="text-center text-muted mt-5 py-5 d-none">æ‰¾ä¸åˆ°ç›¸é—œå•†å“</div>
        </div>
    </div>

    <div id="auth-error-view" class="container" style="display:none;"></div>

    <div class="backdrop" id="backdrop" onclick="closeModal()"></div>
    <div class="modal-bottom" id="priceModal">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h5 class="m-0 fw-bold text-dark" id="modal-p-name">--</h5>
                <div class="text-muted small mt-1" id="modal-p-spec">--</div>
            </div>
            <button type="button" class="btn-close" onclick="closeModal()"></button>
        </div>

        <form id="priceForm">
            <input type="hidden" id="form_product_id">
            <input type="hidden" id="old_base_price">
            <input type="hidden" id="old_promo_type">
            <input type="hidden" id="old_promo_qty">
            <input type="hidden" id="old_promo_val">

            <div class="mb-3">
                <label class="form-label small text-muted fw-bold">å–®ä»¶åŸåƒ¹ (Base Price)</label>
                <div class="input-group">
                    <span class="input-group-text bg-light fw-bold">$</span>
                    <input type="number" id="inp_base_price" class="form-control form-control-lg fw-bold" 
                           placeholder="è‹¥ç„¡å–®è³£è«‹ç•™ç©ºï¼Œç”±ä¸‹æ–¹è‡ªå‹•ç®—" inputmode="decimal" oninput="calculate()">
                </div>
                <div class="form-text text-muted" style="font-size: 0.75rem;">
                    * æ²’å–®åƒ¹ï¼Ÿè«‹ç›´æ¥å¡«ä¸‹æ–¹æ´»å‹•ï¼Œç³»çµ±è‡ªå‹•å¹«æ‚¨ç®—å–®åƒ¹ã€‚
                </div>
            </div>

            <div class="mb-2 position-relative">
                <div id="current-promo-hint" class="current-promo-warning d-none">
                    âš ï¸ ç›®å‰è¨­å®šï¼š<span id="hint-text">--</span>
                </div>

                <label class="form-label small text-muted fw-bold">ä¿ƒéŠ·æ´»å‹•</label>
                <select id="inp_promo_type" class="form-select" onchange="togglePromoFields()">
                    <option value="1">ç„¡ (å–®ä»¶åƒ¹æ ¼)</option>
                    <option value="2">ğŸ“¦ å¤šä»¶å„ªæƒ  (ä¾‹: 2ä»¶$60)</option>
                    <option value="3">ğŸ·ï¸ æŠ˜æ‰£å„ªæƒ  (ä¾‹: 2ä»¶88æŠ˜)</option>
                    <option value="4">ğŸ è²· X é€ Y (ä¾‹: è²·1é€1)</option>
                    <option value="5">â• åŠ è³¼å„ªæƒ  (ä¾‹: ç¬¬2ä»¶$10)</option>
                    <option value="6">ğŸ“‰ æŒ‡å®šæŠ˜æ‰£ (ä¾‹: ç¬¬2ä»¶6æŠ˜)</option>
                </select>
            </div>

            <div id="promo-fields" class="bg-light p-3 rounded mb-3 d-none border border-dashed">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="small text-muted fw-bold" id="lbl_qty">æ•¸é‡</label>
                        <input type="number" id="inp_promo_qty" class="form-control" inputmode="numeric" oninput="calculate()">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold" id="lbl_val">æ•¸å€¼</label>
                        <input type="number" id="inp_promo_val" class="form-control" inputmode="decimal" oninput="calculate()">
                    </div>
                </div>
                <div class="small mt-2 text-primary fw-bold text-end" id="promo-desc-hint"></div>
            </div>

            <div class="alert alert-primary py-2 d-flex justify-content-between align-items-center">
                <span class="small">æ›ç®—å–®åƒ¹ï¼š</span>
                <span class="fw-bold fs-4" id="display_unit_price">$ --</span>
            </div>
            
            <input type="hidden" id="final_price">

            <button type="submit" class="btn btn-dark w-100 py-3 rounded-pill fw-bold shadow-sm">
                ç¢ºèªæ›´æ–° <small class="text-warning ms-1">(è–ªè³‡+5)</small>
            </button>
        </form>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const LIFF_ID = "{{ liff_id }}";
        const products = {{ products | tojson }};
        const chains = {{ chains | tojson }};
        const priceMap = {{ price_map | tojson }}; 
        // ğŸ”¥ æ¥æ”¶å¾Œç«¯å‚³ä¾†çš„ä»Šæ—¥ç›¤é»ç´€éŒ„ (åŒ…å« staff_name)
        const rawAuditLogs = {{ audit_logs | tojson }} || [];

        let userLineId = "";
        let currentChainId = -1;
        let activeCategory = 'all';

        window.onload = async function() {
            if (LIFF_ID) {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) { 
                        liff.login({ redirectUri: window.location.href });
                        return; 
                    }
                    const profile = await liff.getProfile();
                    userLineId = profile.userId;
                    checkStaffStatus(userLineId);
                } catch (e) { 
                    alert('LIFF Error: ' + e); 
                    document.getElementById('loading-overlay').style.display = 'none'; 
                }
            }
        };

        function checkStaffStatus(uid) {
            fetch('/api/staff/check', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ line_id: uid })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading-overlay').style.display = 'none';
                if (data.status === 'success') {
                    document.getElementById('main-ui').style.display = 'block';
                    document.getElementById('staff-name').textContent = data.name;
                    document.getElementById('wallet-box').style.display = 'block';
                    document.getElementById('wallet-amt').textContent = data.wallet;
                    
                    if (data.level >= 9) {
                        setupChainSelector();
                        currentChainId = chains[0]?.id || -1;
                        updateChainDisplay();
                    } else {
                        currentChainId = data.chain_id;
                        const chain = chains.find(c => c.id == currentChainId);
                        document.getElementById('chain-text').textContent = chain ? chain.name : 'æœªç¶å®š';
                    }
                    initCategoryFilter();
                    filterProducts(); 
                    // ğŸ”¥ ç™»å…¥æˆåŠŸå¾Œï¼Œç«‹åˆ»æ¨™è¨˜å·²ç›¤é»
                    markAuditedProducts();
                } else {
                    showAuthError(data.status, uid);
                }
            })
            .catch(err => alert("API Error: " + err));
        }

        function updateChainDisplay() {
            const chain = chains.find(c => c.id == currentChainId);
            document.getElementById('chain-text').textContent = chain ? chain.name : 'è«‹é¸æ“‡';
        }

        function initCategoryFilter() {
            const cats = [...new Set(products.map(p => p.category))];
            const bar = document.getElementById('category-filter');
            let html = `<div class="filter-chip active" onclick="setCategory('all', this)">å…¨éƒ¨</div>`;
            cats.forEach(c => { html += `<div class="filter-chip" onclick="setCategory('${c}', this)">${c}</div>`; });
            bar.innerHTML = html;
        }

        function setCategory(cat, btn) {
            activeCategory = cat;
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterProducts();
            window.scrollTo(0, 0);
        }

        // ğŸ”¥ æ¨™è¨˜å·²ç›¤é»å•†å“çš„å‡½å¼ (åœ˜éšŠå”ä½œç‰ˆ)
        function markAuditedProducts() {
            if (currentChainId < 0) return;

            // 1. æ•´ç†é€™å®¶åº—çš„ç›¤é»ç´€éŒ„ { product_id: staff_name }
            const storeLogs = {};
            rawAuditLogs.forEach(log => {
                if (log.chain_id == currentChainId) {
                    storeLogs[log.product_id] = log.staff_name;
                }
            });

            // 2. éæ­·ç•«é¢å¡ç‰‡
            document.querySelectorAll('.product-card').forEach(card => {
                const prodId = parseInt(card.dataset.id);
                
                // æ¸…é™¤èˆŠç‹€æ…‹
                card.classList.remove('audited');
                const oldBadge = card.querySelector('.audited-badge');
                if(oldBadge) oldBadge.remove();
                const oldTag = card.querySelector('.audited-by-tag');
                if(oldTag) oldTag.remove();

                // 3. æœ‰ç´€éŒ„å°±è®Šè‰²
                if (storeLogs.hasOwnProperty(prodId)) {
                    card.classList.add('audited');
                    
                    // æ‰“å‹¾å‹¾
                    const badge = document.createElement('div');
                    badge.className = 'audited-badge';
                    badge.innerHTML = '<i class="bi bi-check-lg"></i>';
                    card.appendChild(badge);

                    // é¡¯ç¤ºæ˜¯èª°ç›¤çš„
                    const staffName = storeLogs[prodId];
                    // åˆ¤æ–·æ˜¯ä¸æ˜¯æˆ‘è‡ªå·± (å¦‚æœæœ‰ userLineId ä¸” Log è£¡æœ‰æˆ‘çš„è¨˜éŒ„)
                    const isMe = rawAuditLogs.some(l => l.product_id == prodId && l.chain_id == currentChainId && l.staff_line_id == userLineId);
                    
                    const tag = document.createElement('div');
                    tag.className = 'audited-by-tag';
                    tag.innerHTML = isMe ? 'âœ… å·²å®Œæˆ' : `ğŸ‘¤ ${staffName}`;
                    card.appendChild(tag);
                }
            });
        }

        function filterProducts() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            const container = document.getElementById('product-list');
            const emptyMsg = document.getElementById('empty-msg');
            container.innerHTML = "";
            
            const filtered = products.filter(p => {
                const matchCat = (activeCategory === 'all') || (p.category === activeCategory);
                const content = (p.name + p.category).toLowerCase();
                const matchKey = !keyword || content.includes(keyword);
                return matchCat && matchKey;
            });

            if (filtered.length === 0) {
                emptyMsg.classList.remove('d-none');
                return;
            }
            emptyMsg.classList.add('d-none');

            filtered.forEach(p => {
                const key = `${currentChainId}-${p.id}`;
                const info = priceMap[key];
                const priceText = info ? `$${info.price}` : '<span class="text-muted fs-6">--</span>';
                const promoHtml = (info && info.label) ? `<span class="p-promo-tag">${info.label}</span>` : '';
                let specStr = "";
                if (p.spec) specStr += `<span class="p-spec-tag">${p.spec}</span>`;
                if (p.material) specStr += `<span class="p-spec-tag">${p.material}</span>`;

                const div = document.createElement('div');
                div.className = "product-card";
                // ğŸ”¥ å¿…é ˆåŠ ä¸Š data-id ä¾›æ¨™è¨˜å‡½å¼ä½¿ç”¨
                div.dataset.id = p.id;
                div.onclick = (e) => openModal(p.id, p.name, p.spec, p.material);
                
                div.innerHTML = `
                    <div class="p-name">${p.name}</div>
                    <div class="p-meta mb-1">${specStr}</div>
                    <div class="p-action-row">
                        <div class="btn-edit-action"><i class="bi bi-pencil-square"></i> ä¿®æ”¹åƒ¹æ ¼ âœ</div>
                        <div class="text-end">
                            <div class="d-flex align-items-center justify-content-end">
                                ${promoHtml}
                                <span class="p-price-display">${priceText}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            // ğŸ”¥ æ¸²æŸ“å®Œç«‹åˆ»æ¨™è¨˜é¡è‰²
            markAuditedProducts();
        }

        function openModal(pid, name, spec, mat) {
            const key = `${currentChainId}-${pid}`;
            const info = priceMap[key];
            document.getElementById('form_product_id').value = pid;
            document.getElementById('modal-p-name').textContent = name;
            document.getElementById('modal-p-spec').textContent = `${spec || ''} ${mat || ''}`;

            if (info) {
                document.getElementById('inp_base_price').value = info.base_price || '';
                document.getElementById('inp_promo_type').value = info.type || 1;
                document.getElementById('inp_promo_qty').value = info.qty > 1 ? info.qty : '';
                document.getElementById('inp_promo_val').value = info.val > 0 ? info.val : '';
                
                if (info.label) {
                    document.getElementById('current-promo-hint').classList.remove('d-none');
                    document.getElementById('hint-text').textContent = `${info.label} (æ›ç®—å–®åƒ¹ $${info.price})`;
                } else {
                    document.getElementById('current-promo-hint').classList.add('d-none');
                }
            } else {
                document.getElementById('inp_base_price').value = '';
                document.getElementById('inp_promo_type').value = 1;
                document.getElementById('inp_promo_qty').value = '';
                document.getElementById('inp_promo_val').value = '';
                document.getElementById('current-promo-hint').classList.add('d-none');
            }
            saveOriginalState();
            togglePromoFields();
            document.getElementById('backdrop').classList.add('show');
            document.getElementById('priceModal').classList.add('show');
        }

        function saveOriginalState() {
            document.getElementById('old_base_price').value = document.getElementById('inp_base_price').value;
            document.getElementById('old_promo_type').value = document.getElementById('inp_promo_type').value;
            document.getElementById('old_promo_qty').value = document.getElementById('inp_promo_qty').value;
            document.getElementById('old_promo_val').value = document.getElementById('inp_promo_val').value;
        }

        function closeModal() {
            document.getElementById('backdrop').classList.remove('show');
            document.getElementById('priceModal').classList.remove('show');
        }

        function togglePromoFields() {
            const type = parseInt(document.getElementById('inp_promo_type').value);
            const group = document.getElementById('promo-fields');
            const lblQty = document.getElementById('lbl_qty');
            const lblVal = document.getElementById('lbl_val');
            const hint = document.getElementById('promo-desc-hint');

            if (type === 1) { group.classList.add('d-none'); } 
            else {
                group.classList.remove('d-none');
                if (type === 2) { lblQty.innerText="ç¸½æ•¸é‡"; lblVal.innerText="ç¸½é‡‘é¡($)"; hint.innerText="ä¾‹: 2ä»¶ 60å…ƒ (å¡«2, 60)"; }
                else if (type === 3) { lblQty.innerText="ç¸½æ•¸é‡"; lblVal.innerText="æŠ˜æ•¸"; hint.innerText="ä¾‹: 88æŠ˜ (å¡«88)"; }
                else if (type === 4) { lblQty.innerText="è²· (ä»¶)"; lblVal.innerText="é€ (ä»¶)"; hint.innerText="ä¾‹: è²·1 é€1 (å¡«1, 1)"; }
                else if (type === 5) { lblQty.innerText="ç¸½æ•¸é‡"; lblVal.innerText="åŠ è³¼åƒ¹($)"; hint.innerText="ä¾‹: ç¬¬2ä»¶ 10å…ƒ (å¡«2, 10)"; }
                else if (type === 6) { lblQty.innerText="ç¸½æ•¸é‡"; lblVal.innerText="ç¬¬Xä»¶æŠ˜æ•¸"; hint.innerText="ä¾‹: ç¬¬2ä»¶ 6æŠ˜ (å¡«2, 60)"; }
            }
            calculate();
        }

        function calculate() {
            const type = parseInt(document.getElementById('inp_promo_type').value);
            let base = parseFloat(document.getElementById('inp_base_price').value) || 0;
            const qty = parseFloat(document.getElementById('inp_promo_qty').value) || 0;
            const val = parseFloat(document.getElementById('inp_promo_val').value) || 0;
            let final = 0;
            let calculatedBase = base;

            if (base <= 0 && type === 2 && qty > 0 && val > 0) {
                calculatedBase = val / qty;
            }

            if (calculatedBase > 0) {
                if (type === 1) final = calculatedBase;
                else if (type === 2 && qty > 0) final = val / qty;
                else if (type === 3 && qty > 0) final = calculatedBase * (val > 1 ? val/100 : val);
                else if (type === 4 && qty > 0) final = (calculatedBase * qty) / (qty + val);
                else if (type === 5 && qty > 1) final = ((calculatedBase * (qty - 1)) + val) / qty;
                else if (type === 6 && qty > 1) {
                    let discount = val > 1 ? val/100 : val;
                    final = ((calculatedBase * (qty - 1)) + (calculatedBase * discount)) / qty;
                }
            } else {
                final = 0;
            }

            const display = final > 0 ? final.toFixed(1) : '0';
            document.getElementById('display_unit_price').textContent = `$ ${display}`;
            document.getElementById('final_price').value = display;
            
            if (base <= 0 && calculatedBase > 0) {
                document.getElementById('display_unit_price').innerHTML = `$ ${display} <span class="badge bg-warning text-dark">è‡ªå‹•åæ¨</span>`;
            }
        }

        document.getElementById('priceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newBase = document.getElementById('inp_base_price').value;
            const newType = document.getElementById('inp_promo_type').value;
            const newQty = document.getElementById('inp_promo_qty').value;
            const newVal = document.getElementById('inp_promo_val').value;

            if (newBase === document.getElementById('old_base_price').value &&
                newType === document.getElementById('old_promo_type').value &&
                newQty === document.getElementById('old_promo_qty').value &&
                newVal === document.getElementById('old_promo_val').value) {
                
                alert("âš ï¸ è³‡æ–™æœªè®Šæ›´ï¼Œä¸éœ€è¦æ›´æ–°");
                closeModal();
                return;
            }

            const price = document.getElementById('final_price').value;
            if (price <= 0) { alert('åƒ¹æ ¼å¿…é ˆå¤§æ–¼ 0'); return; }

            const btn = this.querySelector('button');
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'â³ æ›´æ–°ä¸­...';

            fetch('/api/price/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    line_id: userLineId,
                    chain_id: currentChainId,
                    product_id: document.getElementById('form_product_id').value,
                    price: price, 
                    base_price: document.getElementById('inp_base_price').value,
                    promo_type: newType,
                    promo_qty: newQty,
                    promo_val: newVal
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    // æ›´æ–°æœ¬åœ°åƒ¹æ ¼è¡¨
                    const pid = document.getElementById('form_product_id').value;
                    const key = `${currentChainId}-${pid}`;
                    priceMap[key] = { 
                        price: price, 
                        base_price: document.getElementById('inp_base_price').value,
                        label: data.label,
                        type: parseInt(newType),
                        qty: parseFloat(newQty),
                        val: parseFloat(newVal)
                    };
                    
                    // ğŸ”¥ æ›´æ–°æœ¬åœ° Audit Log (å‡è£å¾Œç«¯å·²ç´€éŒ„ï¼Œè®“ç•«é¢å³æ™‚è®Šç¶ )
                    rawAuditLogs.push({
                        chain_id: parseInt(currentChainId),
                        product_id: parseInt(pid),
                        staff_line_id: userLineId,
                        staff_name: document.getElementById('staff-name').textContent
                    });

                    // é‡æ–°æ¸²æŸ“ä¸¦æ¨™è¨˜
                    filterProducts(); 
                    
                    closeModal();
                    const w = document.getElementById('wallet-amt');
                    if(w) w.textContent = parseInt(w.textContent) + 5;
                } else {
                    alert('âŒ ' + data.msg);
                }
                btn.disabled = false; btn.innerHTML = originalText;
            });
        });

        function setupChainSelector() {
            const sel = document.getElementById('chain-selector');
            sel.classList.remove('d-none');
            document.getElementById('chain-text').style.display = 'none';
            chains.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.name;
                sel.appendChild(opt);
            });
            sel.addEventListener('change', (e) => {
                currentChainId = parseInt(e.target.value);
                filterProducts();
            });
        }

        function showAuthError(status, uid) {
            const box = document.getElementById('auth-error-view');
            box.style.display = 'block';
            let title = status === 'banned' ? 'â›” å¸³è™Ÿåœæ¬Š' : 'ğŸš« æœªæˆæ¬Šè£ç½®';
            let desc = status === 'banned' ? 'è«‹è¯ç¹«ç®¡ç†å“¡' : 'è«‹æˆªåœ–ä¸‹æ–¹ ID çµ¦åº—é•·é–‹é€š';
            box.innerHTML = `<div class="auth-card"><h4 class="text-danger fw-bold mb-3">${title}</h4><p class="text-muted small mb-0">${desc}</p><div class="auth-id-box">${uid}</div></div>`;
        }
    </script>
</body>
</html>