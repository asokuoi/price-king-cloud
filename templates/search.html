<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒ¹æ ¼ç‹ Price King</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f6f9; padding-bottom: 80px; }
        
        /* æœå°‹ Header */
        .search-header { background: #fff; position: sticky; top: 0; z-index: 1050; padding: 12px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .search-input { border-radius: 50px; background: #f1f3f5; border: none; height: 42px; font-weight: 500; padding-left: 45px; }
        
        /* ğŸ”¥ æ™ºæ…§ç¯©é¸ Bar (Smart Filters) */
        .smart-filter-bar { 
            white-space: nowrap; overflow-x: auto; padding: 8px 15px; 
            background: #fff; border-bottom: 1px solid #eee; 
            position: sticky; top: 66px; z-index: 1040; 
            display: flex; gap: 8px; scrollbar-width: none;
        }
        .smart-filter-bar::-webkit-scrollbar { display: none; }
        
        .filter-chip { 
            display: inline-flex; align-items: center; 
            padding: 6px 14px; border-radius: 20px; 
            background: #fff; color: #495057; border: 1px solid #dee2e6;
            font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s;
            flex-shrink: 0;
        }
        .filter-chip.active { 
            background: #212529; color: white; border-color: #212529; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .filter-chip i { margin-right: 4px; font-size: 0.8rem; }

        /* å•†å“å¡ç‰‡å„ªåŒ– (List Group Style) */
        .product-card { 
            background: #fff; border-radius: 12px; margin-bottom: 16px; 
            border: 1px solid #e9ecef; overflow: hidden; position: relative;
        }
        
        /* ğŸ‘‘ å…¨å ´ CP ç¸½éœ¸ä¸»æ¨£å¼ */
        .product-card.global-king { 
            border: 2px solid #ffc107; 
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
        }
        .global-king-badge {
            position: absolute; top: 0; right: 0;
            background: #ffc107; color: #000; font-weight: 800; font-size: 0.75rem;
            padding: 4px 10px; border-bottom-left-radius: 12px;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.1); z-index: 10;
        }

        .p-header { padding: 15px; display: flex; gap: 12px; }
        .p-img-box { width: 70px; height: 70px; flex-shrink: 0; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .p-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .p-info { flex-grow: 1; min-width: 0; }
        .p-name { font-weight: 700; font-size: 1.05rem; color: #212529; line-height: 1.3; margin-bottom: 4px; }
        .p-meta { font-size: 0.85rem; color: #868e96; display: flex; gap: 8px; align-items: center; }
        .p-tag { background: #f1f3f5; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }

        /* åƒ¹æ ¼åˆ—è¡¨ (æŒ‰éˆ•åŒ–) */
        .price-list { border-top: 1px solid #f1f3f5; }
        .price-row { 
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f8f9fa; text-decoration: none; color: inherit;
            transition: background 0.1s; position: relative;
        }
        .price-row:last-child { border-bottom: none; }
        .price-row:active { background-color: #f1f3f5; }

        /* ğŸ”¥ æœ¬æ¬¾æœ€ä¿— (Highlight) */
        .price-row.local-winner { background-color: #f0f7ff; } /* æ·¡è—åº• */
        .global-king .price-row.local-winner { background-color: #fff9db; } /* é‡‘éœ¸ä¸»ç”¨æ·¡é»ƒåº• */
        
        .local-winner-tag {
            font-size: 0.7rem; font-weight: 800; color: #0d6efd;
            background: rgba(13, 110, 253, 0.1); padding: 2px 6px; border-radius: 4px;
            margin-left: 6px; display: inline-block;
        }
        .global-king .local-winner-tag { color: #856404; background: rgba(255, 193, 7, 0.2); }

        .chain-info { display: flex; align-items: center; gap: 10px; }
        .chain-logo { width: 28px; height: 28px; border-radius: 6px; object-fit: contain; border: 1px solid #eee; background: #fff; }
        .chain-name { font-weight: 700; font-size: 0.95rem; color: #343a40; }

        .price-info { text-align: right; }
        .price-val { font-weight: 900; font-size: 1.25rem; color: #dc3545; }
        .price-unit { font-size: 0.75rem; color: #adb5bd; }
        .promo-badge { font-size: 0.7rem; background: #fff0f0; color: #e03131; padding: 2px 6px; border-radius: 4px; margin-right: 4px; font-weight: 700; }
        
        /* æ­·å²ä½åƒ¹ç«æŠŠ ğŸ”¥ */
        .hist-low-badge { 
            font-size: 0.7rem; color: #e67700; font-weight: 800; 
            display: flex; align-items: center; gap: 2px; justify-content: flex-end;
        }

        .chevron { color: #dee2e6; font-size: 0.9rem; margin-left: 10px; }

        /* å¤§å»³æ¨£å¼ç¶­æŒä¸è®Šï¼Œç•¥... */
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; }
        .cat-item { text-align: center; }
        .cat-icon { width: 50px; height: 50px; background: #fff; border-radius: 16px; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cat-text { font-size: 0.8rem; color: #555; }
    </style>
</head>
<body>

<div class="search-header">
    <div class="d-flex gap-2 align-items-center">
        <a href="/search" class="btn btn-light border rounded-circle" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <i class="bi bi-house-door-fill text-secondary"></i>
        </a>
        <div class="position-relative flex-grow-1">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
            <input type="text" id="searchInput" class="form-control search-input" 
                   placeholder="æ‰¾å•¤é…’ (ä¾‹: é‡‘ç‰Œ)" value="{{ search_keyword }}" onkeypress="handleEnter(event)">
        </div>
        <button type="button" class="btn btn-dark rounded-circle" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0;" onclick="performSearch()">
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</div>

<div id="smart-filter-bar" class="smart-filter-bar d-none"></div>

<div id="main-content" class="container pt-3"></div>

<script>
    const products = {{ products_data | safe if products_data else '[]' }};
    const lobbyData = {{ lobby_data | safe }};
    const currentKeyword = "{{ search_keyword }}";
    const currentMode = "{{ search_mode }}";
    const pinId = "{{ pin_id }}";

    // ç´€éŒ„ç›®å‰é¸ä¸­çš„ç¯©é¸æ¢ä»¶
    let activeFilters = {
        spec: null,
        material: null,
        keyword: null
    };

    window.onload = function() {
        const container = document.getElementById('main-content');
        if (!currentKeyword && !currentMode) {
            renderLobby(container);
        } else if (products.length > 0) {
            generateSmartFilters(products); // ğŸ”¥ ç”Ÿæˆç¯©é¸æŒ‰éˆ•
            renderProductCards(products, container);
        } else {
            // æ‰¾ä¸åˆ°å•†å“ (ç¶­æŒæ‚¨çš„å¯æ„›æ©Ÿå™¨äºº)
            renderEmptyState(container);
        }
    };

    // ============================================
    // ğŸ§  1. æ™ºæ…§ç¯©é¸æ ¸å¿ƒ (Smart Filter Logic)
    // ============================================
    function generateSmartFilters(data) {
        const bar = document.getElementById('smart-filter-bar');
        if (currentMode === 'store_shelf') return; // åº—å…§æ¨¡å¼ä¸é¡¯ç¤ºè¤‡é›œç¯©é¸

        // çµ±è¨ˆå‡ºç¾çš„è¦æ ¼ã€æè³ªã€èˆ‡é—œéµå­—
        const specs = new Set();
        const materials = new Set();
        const keywords = new Set();

        data.forEach(p => {
            if (p.spec) specs.add(p.spec);
            if (p.material) materials.add(p.material);
            if (p.keywords) {
                p.keywords.split(',').forEach(k => {
                    if(k.trim()) keywords.add(k.trim());
                });
            }
        });

        // åªæœ‰ç•¶é¸é … > 1 æ™‚æ‰é¡¯ç¤ºæŒ‰éˆ• (å¦‚æœå…¨æ˜¯é‹ç½ï¼Œå°±ä¸ç”¨é¡¯ç¤ºé‹ç½æŒ‰éˆ•)
        let html = '';
        
        // é‡ç½®æŒ‰éˆ•
        html += `<div class="filter-chip active" id="btn-reset" onclick="resetFilters()">å…¨éƒ¨</div>`;

        // è¦æ ¼æŒ‰éˆ• (ä¾‹: 330ml)
        if (specs.size > 1) {
            specs.forEach(s => {
                html += `<div class="filter-chip" onclick="toggleFilter('spec', '${s}', this)">${s}</div>`;
            });
        }
        // æè³ªæŒ‰éˆ• (ä¾‹: ç»ç’ƒç“¶)
        if (materials.size > 1) {
            materials.forEach(m => {
                html += `<div class="filter-chip" onclick="toggleFilter('material', '${m}', this)"><i class="bi bi-funnel"></i>${m}</div>`;
            });
        }
        // é—œéµå­—æŒ‰éˆ• (ä¾‹: é‡‘ç‰Œ) - é€™è£¡å¯ä»¥æ ¹æ“šæ‚¨çš„ keywords æ¬„ä½
        if (keywords.size > 0) {
            keywords.forEach(k => {
                // æ’é™¤å·²ç¶“åœ¨æœå°‹æ¡†æ‰“éçš„å­—
                if (!currentKeyword.includes(k)) {
                    html += `<div class="filter-chip" onclick="toggleFilter('keyword', '${k}', this)">#${k}</div>`;
                }
            });
        }

        if (specs.size > 1 || materials.size > 1 || keywords.size > 0) {
            bar.classList.remove('d-none');
            bar.innerHTML = html;
        }
    }

    function toggleFilter(type, val, btn) {
        // åˆ‡æ›ç‹€æ…‹
        if (activeFilters[type] === val) {
            activeFilters[type] = null; // å–æ¶ˆ
            btn.classList.remove('active');
        } else {
            // åŒé¡äº’æ–¥ (é¸äº†330mlå°±ä¸èƒ½é¸500ml)
            activeFilters[type] = val;
            // æ¸…é™¤åŒé¡åˆ¥çš„å…¶ä»– active
            // (ç°¡å–®å¯¦ä½œï¼šé‡ç¹ªæ•´å€‹åˆ—è¡¨æ¯”è¼ƒå¿«)
        }
        
        updateFilterUI();
        applyFilters();
    }
    
    function resetFilters() {
        activeFilters = { spec: null, material: null, keyword: null };
        updateFilterUI();
        applyFilters();
    }

    function updateFilterUI() {
        // é‡ç¹ªæŒ‰éˆ•æ¨£å¼ (ç°¡å–®æš´åŠ›æ³•)
        const chips = document.querySelectorAll('.filter-chip');
        chips.forEach(c => {
            const txt = c.innerText.replace('#', '').replace('filter_alt', '').trim(); // ç°¡å–®æ¸…ç†
            if (txt === 'å…¨éƒ¨') {
                if (!activeFilters.spec && !activeFilters.material && !activeFilters.keyword) c.classList.add('active');
                else c.classList.remove('active');
            } else {
                // æª¢æŸ¥æ˜¯å¦é¸ä¸­
                if (activeFilters.spec === txt || activeFilters.material === txt || activeFilters.keyword === txt) {
                    c.classList.add('active');
                } else {
                    c.classList.remove('active');
                }
            }
        });
    }

    function applyFilters() {
        const filtered = products.filter(p => {
            let pass = true;
            if (activeFilters.spec && p.spec !== activeFilters.spec) pass = false;
            if (activeFilters.material && p.material !== activeFilters.material) pass = false;
            if (activeFilters.keyword) {
                // æª¢æŸ¥ keywords æ¬„ä½æˆ– name
                const content = (p.keywords + p.name).toLowerCase();
                if (!content.includes(activeFilters.keyword.toLowerCase())) pass = false;
            }
            return pass;
        });
        renderProductCards(filtered, document.getElementById('main-content'));
    }

    // ============================================
    // ğŸ¨ 2. å¡ç‰‡æ¸²æŸ“æ ¸å¿ƒ (Card Rendering)
    // ============================================
    function renderProductCards(data, container) {
        if (data.length === 0) {
            container.innerHTML = `<div class="p-5 text-center text-muted">æ²’æœ‰ç¬¦åˆç¯©é¸çš„å•†å“</div>`;
            return;
        }

        // 1. æ‰¾å‡ºå…¨å ´ CP ç¸½éœ¸ä¸» (Global King) - åªæ‰¾ç›®å‰åˆ—è¡¨ä¸­çš„
        let minGlobalScore = 999999;
        let globalKingId = null;
        data.forEach(p => {
            if (p.cp_score < minGlobalScore) {
                minGlobalScore = p.cp_score;
                globalKingId = p.id;
            }
        });

        let html = '';
        data.forEach(p => {
            // åˆ¤æ–·æ˜¯å¦ç‚ºå…¨å ´éœ¸ä¸»
            const isGlobalKing = (p.id === globalKingId);
            const cardClass = isGlobalKing ? 'product-card global-king' : 'product-card';
            const badgeHtml = isGlobalKing ? `<div class="global-king-badge"><i class="bi bi-trophy-fill"></i> CPéœ¸ä¸»</div>` : '';

            // æº–å‚™åƒ¹æ ¼åˆ—è¡¨
            let priceHtml = '';
            if (p.prices.length > 0) {
                // æ‰¾å‡ºè©²å¡ç‰‡å…§çš„æœ€ä½åƒ¹ (Local Winner)
                const minPrice = Math.min(...p.prices.map(pr => pr.price));

                p.prices.forEach(pr => {
                    const isLocalWinner = (pr.price === minPrice);
                    const rowClass = isLocalWinner ? 'price-row local-winner' : 'price-row';
                    
                    // æ¨™ç±¤é‚è¼¯
                    let tags = '';
                    if (pr.promo_label) tags += `<span class="promo-badge">${pr.promo_label}</span>`;
                    if (isLocalWinner) {
                        if (isGlobalKing) tags += `<span class="local-winner-tag">ç¸½éœ¸ä¸»</span>`;
                        else tags += `<span class="local-winner-tag">æœ¬æ¬¾æœ€ä¿—</span>`;
                    }

                    // æ­·å²ä½åƒ¹ç«æŠŠ ğŸ”¥
                    let histHtml = '';
                    if (pr.is_hist_low) {
                        histHtml = `<div class="hist-low-badge"><i class="bi bi-fire"></i> æ­·å²ä½åƒ¹</div>`;
                    } else if (pr.time_ago) {
                        histHtml = `<div class="text-secondary" style="font-size:0.7rem;">${pr.time_ago}æ›´æ–°</div>`;
                    }

                    // é€£çµ
                    const linkUrl = `/search?mode=store_shelf&chain_id=${pr.chain_id}&pin_id=${p.id}`;

                    priceHtml += `
                        <div class="${rowClass}" onclick="goToUrlWithGPS('${linkUrl}')">
                            <div class="chain-info">
                                ${pr.chain_logo ? `<img src="${pr.chain_logo}" class="chain-logo">` : ''}
                                <div class="chain-name">${pr.chain_name}</div>
                            </div>
                            <div class="price-info">
                                <div>${tags} <span class="price-val">$${pr.price}</span></div>
                                ${histHtml}
                            </div>
                            <i class="bi bi-chevron-right chevron"></i>
                        </div>
                    `;
                });
            } else {
                priceHtml = `<div class="p-3 text-center text-muted" style="font-size:0.85rem;">æš«ç„¡å ±åƒ¹</div>`;
            }

            // æœå°‹é—œéµå­— (é»æ¨™é¡Œå†æœä¸€æ¬¡)
            const searchUrl = `/search?keyword=${encodeURIComponent(p.name)}`;

            html += `
                <div class="${cardClass}">
                    ${badgeHtml}
                    <div class="p-header">
                        <div class="p-img-box">
                            ${p.image_url ? `<img src="${p.image_url}" class="p-img">` : '<i class="bi bi-image text-muted"></i>'}
                        </div>
                        <div class="p-info">
                            <div class="p-name" onclick="goToUrlWithGPS('${searchUrl}')">${p.name}</div>
                            <div class="p-meta">
                                ${p.spec ? `<span class="p-tag">${p.spec}</span>` : ''}
                                ${p.material ? `<span class="p-tag">${p.material}</span>` : ''}
                                <span class="ms-auto" style="font-size:0.75rem;">${p.cp_score < 999 ? '$'+p.cp_score.toFixed(2)+'/'+(p.unit||'ml') : ''}</span>
                            </div>
                        </div>
                    </div>
                    <div class="price-list">
                        ${priceHtml}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // é€šç”¨èˆ‡å¤§å»³å‡½å¼ç¶­æŒä¸è®Š...
    function renderLobby(container) {
        let html = `
            <h6 class="px-2 text-secondary fw-bold mb-3" style="font-size:0.9rem;">ç†±é–€é€šè·¯</h6>
            <div class="cat-grid">
                ${lobbyData.chains.map(c => `
                    <div class="cat-item" onclick="goToUrlWithGPS('/search?mode=store_shelf&chain_id=${c.id}')">
                        <div class="cat-icon">${c.logo_url ? `<img src="${c.logo_url}" style="width:30px;">` : c.icon}</div>
                        <div class="cat-text">${c.name}</div>
                    </div>`).join('')}
            </div>
            <h6 class="px-2 text-secondary fw-bold mt-4 mb-3" style="font-size:0.9rem;">å•†å“åˆ†é¡</h6>
            <div class="cat-grid">
                ${lobbyData.categories.map(c => `
                    <div class="cat-item" onclick="goToUrlWithGPS('/search?keyword=${encodeURIComponent(c.name)}')">
                        <div class="cat-icon">${c.icon}</div>
                        <div class="cat-text">${c.name}</div>
                    </div>`).join('')}
            </div>`;
        container.innerHTML = html;
    }

    function renderEmptyState(container) {
        container.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center pt-5 mt-5">
                <i class="bi bi-robot text-secondary mb-3" style="font-size: 3rem;"></i>
                <h5 class="fw-bold text-dark">æ‰¾ä¸åˆ°å•†å“</h5>
                <p class="text-secondary small">æ›å€‹é—œéµå­—è©¦è©¦çœ‹ï¼Ÿ</p>
                <a href="/search" class="btn btn-outline-dark rounded-pill px-4 mt-2">å›å¤§å»³</a>
            </div>`;
    }

    function handleEnter(event) { if (event.key === 'Enter') performSearch(); }
    function performSearch() {
        const input = document.getElementById('searchInput');
        if (input && input.value.trim()) goToUrlWithGPS(`/search?keyword=${encodeURIComponent(input.value.trim())}`);
    }

    // ğŸš€ GPS è·³è½‰é‚è¼¯ (ç¶­æŒä¸è®Š)
    function goToUrlWithGPS(targetUrl) {
        let separator = targetUrl.includes('?') ? '&' : '?';
        let finalUrl = targetUrl;
        try {
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    finalUrl += `${separator}line_id=${profile.userId}`;
                    executeRedirect(finalUrl); 
                }).catch(() => executeRedirect(finalUrl));
            } else executeRedirect(finalUrl);
        } catch (e) { executeRedirect(finalUrl); }
    }
    function executeRedirect(baseUrl) {
        if (!navigator.geolocation) { window.location.href = baseUrl; return; }
        navigator.geolocation.getCurrentPosition(
            (pos) => { window.location.href = `${baseUrl}&lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`; },
            (err) => { window.location.href = baseUrl; },
            { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 } 
        );
    }
    window.addEventListener('load', function() { if (typeof liff !== 'undefined') liff.init({ liffId: "{{ liff_id }}" }); });
</script>
</body>
</html>