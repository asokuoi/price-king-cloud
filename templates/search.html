<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒ¹æ ¼ç‹ Price King</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; padding-bottom: 80px; }
        
        /* æœå°‹ Header */
        .search-header { background: #fff; position: sticky; top: 0; z-index: 1050; padding: 12px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .search-input { border-radius: 50px; background: #f1f3f5; border: none; height: 42px; font-weight: 500; padding-left: 45px; }
        
        /* æ™ºæ…§ç¯©é¸ Bar */
        .smart-filter-bar { 
            white-space: nowrap; overflow-x: auto; padding: 10px 15px; 
            background: #fff; border-bottom: 1px solid #eee; 
            position: sticky; top: 66px; z-index: 1040; 
            display: flex; gap: 8px; scrollbar-width: none;
        }
        .smart-filter-bar::-webkit-scrollbar { display: none; }
        
        .filter-chip { 
            display: inline-flex; align-items: center; justify-content: center;
            padding: 8px 16px; border-radius: 20px; 
            background: #fff; color: #495057; border: 1px solid #e9ecef;
            font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s;
            flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .filter-chip.active { 
            background: #212529; color: white; border-color: #212529; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* =========================================
           å•†å“å¡ç‰‡ V3.1
           ========================================= */
        .product-card { 
            background: #fff; border-radius: 16px; margin-bottom: 16px; 
            /* ğŸ”¥ ç²‰è‰²é‚Šæ¡† (é è¨­) */
            border: 2px solid #ffecf0; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            overflow: hidden; position: relative;
        }
        
        /* ğŸ‘‘ CP éœ¸ä¸» (é‡‘æ¡† override) */
        .product-card.global-king { border: 2px solid #ffc107; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.15); }
        
        /* ğŸ“ åº—å…§æ¨¡å¼ (è—é‚Š override) */
        .product-card.store-mode { border: 2px solid #dee2e6; border-left: 6px solid #0d6efd; }
        
        /* ğŸ“Œ æ‚¨é¸æ“‡çš„ (ç½®é ‚ç™¼å…‰) */
        .product-card.pinned-card { 
            border: 2px solid #0d6efd; background: #f8fbff; 
            box-shadow: 0 0 20px rgba(13, 110, 253, 0.15); 
        }

        /* å¾½ç«  */
        .badge-float {
            position: absolute; top: 0; right: 0; font-weight: 800; font-size: 0.75rem;
            padding: 5px 12px; border-bottom-left-radius: 12px; z-index: 10;
        }
        .global-king-badge { background: #ffc107; color: #000; }
        .pinned-badge { background: #0d6efd; color: #fff; }

        /* å…§å®¹å€ */
        .p-header { padding: 18px 15px 12px 15px; }
        .p-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .p-name { font-weight: 800; font-size: 1.2rem; color: #212529; line-height: 1.3; }
        .p-category { font-size: 0.75rem; color: #adb5bd; border: 1px solid #f0f0f0; padding: 2px 8px; border-radius: 6px; height: fit-content; margin-left: 10px; white-space: nowrap; }

        .p-meta { font-size: 0.85rem; display: flex; gap: 6px; align-items: center; }
        .p-tag { background: #f8f9fa; padding: 4px 10px; border-radius: 6px; font-weight: 600; color: #6c757d; font-size: 0.8rem; }
        .p-cp { color: #0d6efd; font-weight: 700; font-size: 0.9rem; margin-left: auto; }

        /* åƒ¹æ ¼åˆ—è¡¨ */
        .price-list { border-top: 1px solid #f1f3f5; }
        
        .price-row { 
            padding: 14px 15px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f8f9fa; cursor: pointer;
            transition: background 0.1s;
        }
        .price-row:last-child { border-bottom: none; }
        .price-row:active { background-color: #f8f9fa; }
        
        /* è´å®¶é«˜äº® */
        .price-row.local-winner { background-color: #f8fbff; } 
        .global-king .price-row.local-winner { background-color: #fffbf0; }

        .chain-info { display: flex; align-items: center; gap: 12px; }
        .chain-logo { width: 32px; height: 32px; border-radius: 8px; object-fit: contain; border: 1px solid #f0f0f0; background: #fff; }
        .chain-name { font-weight: 700; font-size: 1rem; color: #343a40; }
        
        .price-right { text-align: right; }
        .price-current { font-weight: 900; font-size: 1.25rem; color: #dc3545; line-height: 1; }
        .price-origin { text-decoration: line-through; color: #adb5bd; font-size: 0.8rem; margin-left: 4px; font-weight: 400; }
        
        /* ğŸ”¥ ä¿ƒéŠ·æ¨™ç±¤ (æ·¡é»ƒåº•) */
        .promo-badge { 
            font-size: 0.75rem; background: #fff8c4; color: #b08d00; 
            padding: 2px 8px; border-radius: 4px; font-weight: 700; margin-bottom: 4px; display: inline-block;
        }

        /* ğŸ”µ å‰å¾€æŒ‰éˆ• (å¢å¼·é»æ“Šæ„Ÿ) */
        .btn-go {
            width: 28px; height: 28px; border-radius: 50%; background: #f1f3f5; 
            color: #0d6efd; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; margin-left: 10px; transition: all 0.2s;
        }
        .price-row:active .btn-go { background: #0d6efd; color: white; }

        /* åº—å…§æ¨¡å¼å¤§åƒ¹æ ¼ */
        .store-price-box { 
            padding: 16px; display: flex; align-items: center; justify-content: space-between; background: #fff; 
        }
        .store-action-link { color: #0d6efd; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 4px; }

        /* å¤§å»³æ¨£å¼ */
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 15px; }
        .cat-item { text-align: center; }
        .cat-icon { width: 54px; height: 54px; background: #fff; border-radius: 18px; margin: 0 auto 6px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; box-shadow: 0 4px 10px rgba(0,0,0,0.04); color: #495057; }
        .cat-text { font-size: 0.85rem; color: #6c757d; font-weight: 500; }
    </style>
</head>
<body>

<div class="search-header">
    <div class="d-flex gap-2 align-items-center">
        <a href="/search" class="btn btn-light border rounded-circle" style="width:42px;height:42px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <i class="bi bi-house-door-fill text-secondary"></i>
        </a>
        <div class="position-relative flex-grow-1">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
            <input type="text" id="searchInput" class="form-control search-input" 
                   placeholder="æ‰¾å•¤é…’ (ä¾‹: é‡‘ç‰Œ)" value="{{ search_keyword }}" onkeypress="handleEnter(event)">
        </div>
        <button type="button" class="btn btn-dark rounded-circle" style="width:42px;height:42px;display:flex;align-items:center;justify-content:center;flex-shrink:0;" onclick="performSearch()">
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</div>

<div id="smart-filter-bar" class="smart-filter-bar d-none"></div>

<div id="main-content" class="container pt-3"></div>

<script>
    const products = {{ products_data | safe if products_data else '[]' }};
    const lobbyData = {{ lobby_data | safe }};
    const currentKeyword = "{{ search_keyword }}";
    const currentMode = "{{ search_mode }}";
    const pinId = "{{ pin_id }}";

    let activeFilters = { spec: null, material: null, keyword: null };

    // ==========================================
    // âš¡ GPS æ¥µé€Ÿç·©å­˜é‚è¼¯ (Session Cache)
    // ==========================================
    // é€²é é¢æ™‚ï¼Œæª¢æŸ¥ç¶²å€æœ‰æ²’æœ‰ GPSï¼Œæœ‰å°±å­˜èµ·ä¾†ï¼›æ²’æœ‰å°±çœ‹æš«å­˜æœ‰æ²’æœ‰ï¼›å†æ²’æœ‰æ‰å»æŠ“
    window.onload = function() {
        initGPS(); // å„ªå…ˆè™•ç† GPS

        const container = document.getElementById('main-content');
        if (!currentKeyword && !currentMode) {
            renderLobby(container);
        } else if (products.length > 0) {
            generateSmartFilters(products); 
            renderProductCards(products, container);
        } else {
            renderEmptyState(container);
        }
    };

    function initGPS() {
        const urlParams = new URLSearchParams(window.location.search);
        const u_lat = urlParams.get('lat');
        const u_lng = urlParams.get('lng');
        const u_uid = urlParams.get('line_id');

        // 1. å¦‚æœç¶²å€å¸¶æœ‰ GPSï¼Œå¼·åˆ¶æ›´æ–° Cache
        if (u_lat && u_lng) {
            sessionStorage.setItem('u_lat', u_lat);
            sessionStorage.setItem('u_lng', u_lng);
        }
        if (u_uid) {
            sessionStorage.setItem('u_uid', u_uid);
        }
    }

    // ğŸ”¥ é€™æ˜¯æ‚¨è¦çš„ã€Œä¸å¡é “ã€è·³è½‰ï¼šå„ªå…ˆè®€æš«å­˜ï¼Œ0ç§’åæ‡‰
    function goToUrlWithGPS(targetUrl) {
        let separator = targetUrl.includes('?') ? '&' : '?';
        let finalUrl = targetUrl;
        
        const cachedLat = sessionStorage.getItem('u_lat');
        const cachedLng = sessionStorage.getItem('u_lng');
        const cachedUid = sessionStorage.getItem('u_uid');

        // A. æœ‰æš«å­˜ -> ç›´æ¥é£›
        if (cachedLat && cachedLng) {
            finalUrl += `${separator}lat=${cachedLat}&lng=${cachedLng}`;
            if (cachedUid) finalUrl += `&line_id=${cachedUid}`;
            window.location.href = finalUrl;
            return;
        }

        // B. æ²’æš«å­˜ -> ä¹–ä¹–æŠ“ä¸€æ¬¡ (åªæœƒç™¼ç”Ÿåœ¨ç¬¬ä¸€æ¬¡)
        try {
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    sessionStorage.setItem('u_uid', profile.userId); // å­˜èµ·ä¾†
                    finalUrl += `${separator}line_id=${profile.userId}`;
                    executeRedirect(finalUrl); 
                }).catch(() => executeRedirect(finalUrl));
            } else executeRedirect(finalUrl);
        } catch (e) { executeRedirect(finalUrl); }
    }

    function executeRedirect(baseUrl) {
        if (!navigator.geolocation) { window.location.href = baseUrl; return; }
        navigator.geolocation.getCurrentPosition(
            (pos) => { 
                // æŠ“åˆ°äº†ï¼å­˜èµ·ä¾†ï¼
                sessionStorage.setItem('u_lat', pos.coords.latitude);
                sessionStorage.setItem('u_lng', pos.coords.longitude);
                window.location.href = `${baseUrl}&lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`; 
            },
            (err) => { window.location.href = baseUrl; },
            { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 } 
        );
    }


    // ==========================================
    // ğŸ¨ æ¸²æŸ“é‚è¼¯
    // ==========================================

    function generateSmartFilters(data) {
        // ... (ç¶­æŒåŸæ¨£ï¼Œç¯‡å¹…çœç•¥ï¼ŒåŠŸèƒ½ä¸è®Š) ...
        const bar = document.getElementById('smart-filter-bar');
        const specs = new Set();
        const materials = new Set();
        const categories = new Set();

        data.forEach(p => {
            if (p.spec) specs.add(p.spec);
            if (p.material) materials.add(p.material);
            if (p.category) categories.add(p.category);
        });

        let html = `<div class="filter-chip active" onclick="resetFilters(this)">å…¨éƒ¨</div>`;
        if (categories.size > 1) categories.forEach(c => html += `<div class="filter-chip" onclick="toggleFilter('keyword', '${c}', this)">${c}</div>`);
        if (specs.size > 1) specs.forEach(s => html += `<div class="filter-chip" onclick="toggleFilter('spec', '${s}', this)">${s}</div>`);
        if (materials.size > 1) materials.forEach(m => html += `<div class="filter-chip" onclick="toggleFilter('material', '${m}', this)">${m}</div>`);

        if (categories.size > 1 || specs.size > 1 || materials.size > 1) {
            bar.classList.remove('d-none');
            bar.innerHTML = html;
        }
    }
    
    function toggleFilter(type, val, btn) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeFilters = { spec: null, material: null, keyword: null };
        activeFilters[type] = val;
        applyFilters();
    }
    function resetFilters(btn) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeFilters = { spec: null, material: null, keyword: null };
        applyFilters();
    }
    function applyFilters() {
        const filtered = products.filter(p => {
            let pass = true;
            if (activeFilters.spec && p.spec !== activeFilters.spec) pass = false;
            if (activeFilters.material && p.material !== activeFilters.material) pass = false;
            if (activeFilters.keyword) {
                const content = (p.category + p.keywords + p.name).toLowerCase();
                if (!content.includes(activeFilters.keyword.toLowerCase())) pass = false;
            }
            return pass;
        });
        renderProductCards(filtered, document.getElementById('main-content'));
    }

    function renderProductCards(data, container) {
        if (data.length === 0) {
            container.innerHTML = `<div class="p-5 text-center text-muted">ç„¡ç¬¦åˆå•†å“</div>`;
            return;
        }

        let html = '';
        
        // 1. è¨ˆç®— Mode B çš„åº—å…§éœ¸ä¸»
        let storeKingId = null;
        if (currentMode === 'store_shelf') {
            let minStoreScore = 999999;
            data.forEach(p => {
                const myPrice = p.prices.find(pr => pr.is_target_store);
                if (myPrice && p.local_score < minStoreScore) {
                    minStoreScore = p.local_score;
                    storeKingId = p.id;
                }
            });
        }

        // 2. è¨ˆç®— Mode A çš„å…¨ç¶²éœ¸ä¸»
        let globalKingId = null;
        if (currentMode !== 'store_shelf') {
            let minGlobalScore = 999999;
            data.forEach(p => {
                if (p.cp_score < minGlobalScore) {
                    minGlobalScore = p.cp_score;
                    globalKingId = p.id;
                }
            });
        }

        // 3. ç½®é ‚è™•ç†
        let displayData = [...data];
        if (pinId) {
            const pinnedIndex = displayData.findIndex(p => String(p.id) === String(pinId));
            if (pinnedIndex > -1) {
                const pinnedItem = displayData.splice(pinnedIndex, 1)[0];
                displayData.unshift(pinnedItem);
            }
        }

        displayData.forEach(p => {
            const isStoreKing = (currentMode === 'store_shelf' && p.id === storeKingId);
            const isGlobalKing = (currentMode !== 'store_shelf' && p.id === globalKingId);
            const isPinned = (String(p.id) === String(pinId));
            
            let cardClass = 'product-card';
            let badgeHtml = '';

            if (currentMode === 'store_shelf') {
                cardClass += ' store-mode';
                if (isStoreKing) { 
                    cardClass += ' store-king';
                    badgeHtml = `<div class="badge-float global-king-badge"><i class="bi bi-star-fill"></i> æœ¬åº—CPç‹</div>`;
                }
            } else {
                // Mode A: CPç‹é‡‘æ¡†ï¼Œå…¶ä»–äººç²‰æ¡†(å·²å¯«åœ¨CSSé è¨­)
                if (isGlobalKing) {
                    cardClass += ' global-king';
                    badgeHtml = `<div class="badge-float global-king-badge"><i class="bi bi-trophy-fill"></i> CPéœ¸ä¸»</div>`;
                }
            }
            
            // ç½®é ‚è¦†è“‹
            if (isPinned) {
                cardClass += ' pinned-card';
                badgeHtml = `<div class="badge-float pinned-badge"><i class="bi bi-check-circle-fill"></i> æ‚¨é¸æ“‡çš„</div>`;
            }

            const searchUrl = `/search?keyword=${encodeURIComponent(p.name)}`;
            
            let priceBody = '';
            
            if (currentMode === 'store_shelf') {
                // [æ¨¡å¼ B]
                const targetPrice = p.prices.find(pr => pr.is_target_store);
                if (targetPrice) {
                    // åŸåƒ¹é¡¯ç¤ºé‚è¼¯
                    const originHtml = (targetPrice.base_price > targetPrice.price) 
                        ? `<span class="price-origin">$${targetPrice.base_price}</span>` : '';
                        
                    priceBody = `
                        <div class="store-price-box" onclick="goToUrlWithGPS('${searchUrl}')">
                            <div class="d-flex flex-column">
                                ${targetPrice.promo_label ? `<span class="promo-badge">${targetPrice.promo_label}</span>` : ''}
                                <div>
                                    <span class="store-price-val">$${targetPrice.price}</span>
                                    ${originHtml}
                                </div>
                            </div>
                            <div class="store-action-link">
                                å…¨ç¶²æ¯”åƒ¹ <i class="bi bi-arrow-right-circle-fill" style="font-size:1.4rem;"></i>
                            </div>
                        </div>`;
                } else { return; }
            } else {
                // [æ¨¡å¼ A]
                if (p.prices.length > 0) {
                    const minPrice = Math.min(...p.prices.map(pr => pr.price));
                    p.prices.forEach(pr => {
                        const isLocalWinner = (pr.price === minPrice);
                        let rowClass = isLocalWinner ? 'price-row local-winner' : 'price-row';
                        const linkUrl = `/search?mode=store_shelf&chain_id=${pr.chain_id}&pin_id=${p.id}`;
                        
                        // åŸåƒ¹é¡¯ç¤º
                        const originHtml = (pr.base_price > pr.price) 
                            ? `<span class="price-origin">$${pr.base_price}</span>` : '';

                        let promoHtml = '';
                        if (pr.promo_label) promoHtml = `<div class="promo-badge">${pr.promo_label}</div>`;

                        priceBody += `
                            <div class="${rowClass}" onclick="goToUrlWithGPS('${linkUrl}')">
                                <div class="chain-info">
                                    ${pr.chain_logo ? `<img src="${pr.chain_logo}" class="chain-logo">` : ''}
                                    <div class="chain-name">${pr.chain_name}</div>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="price-right">
                                        ${promoHtml}
                                        <div>
                                            <span class="price-current">$${pr.price}</span>
                                            ${originHtml}
                                        </div>
                                    </div>
                                    <div class="btn-go"><i class="bi bi-chevron-right"></i></div>
                                </div>
                            </div>`;
                    });
                } else {
                    priceBody = `<div class="p-3 text-center text-muted small">æš«ç„¡å ±åƒ¹</div>`;
                }
            }

            html += `
                <div class="${cardClass}">
                    ${badgeHtml}
                    <div class="p-header">
                        <div class="p-top-row">
                            <div class="p-name" onclick="goToUrlWithGPS('${searchUrl}')">${p.name}</div>
                            <div class="p-category">${p.category}</div>
                        </div>
                        <div class="p-meta">
                            ${p.spec ? `<span class="p-tag">${p.spec}</span>` : ''}
                            ${p.material ? `<span class="p-tag">${p.material}</span>` : ''}
                            <span class="p-cp">
                                ${p.cp_score < 999 ? '$'+p.cp_score.toFixed(2)+'/'+(p.unit||'ml') : ''}
                            </span>
                        </div>
                    </div>
                    <div class="price-list">
                        ${priceBody}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function renderLobby(container) {
        let html = `
            <h6 class="px-2 text-secondary fw-bold mb-3 small">ç†±é–€é€šè·¯</h6>
            <div class="cat-grid">
                ${lobbyData.chains.map(c => `
                    <div class="cat-item" onclick="goToUrlWithGPS('/search?mode=store_shelf&chain_id=${c.id}')">
                        <div class="cat-icon">${c.logo_url ? `<img src="${c.logo_url}" style="width:30px;">` : c.icon}</div>
                        <div class="cat-text">${c.name}</div>
                    </div>`).join('')}
            </div>
            <h6 class="px-2 text-secondary fw-bold mt-4 mb-3 small">å•†å“åˆ†é¡</h6>
            <div class="cat-grid">
                ${lobbyData.categories.map(c => `
                    <div class="cat-item" onclick="goToUrlWithGPS('/search?keyword=${encodeURIComponent(c.name)}')">
                        <div class="cat-icon">${c.icon}</div>
                        <div class="cat-text">${c.name}</div>
                    </div>`).join('')}
            </div>`;
        container.innerHTML = html;
    }

    function renderEmptyState(container) {
        container.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center pt-5 mt-5">
                <i class="bi bi-robot text-secondary mb-3" style="font-size: 3rem;"></i>
                <h5 class="fw-bold text-dark">æ‰¾ä¸åˆ°å•†å“</h5>
                <a href="/search" class="btn btn-outline-dark rounded-pill px-4 mt-2">å›å¤§å»³</a>
            </div>`;
    }

    function handleEnter(event) { if (event.key === 'Enter') performSearch(); }
    function performSearch() {
        const input = document.getElementById('searchInput');
        if (input && input.value.trim()) goToUrlWithGPS(`/search?keyword=${encodeURIComponent(input.value.trim())}`);
    }
    
    // LIFF Init
    window.addEventListener('load', function() { if (typeof liff !== 'undefined') liff.init({ liffId: "{{ liff_id }}" }); });
</script>
</body>
</html>