<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <base href="/">
    <title>ÂÉπÊ†ºÁéã Price King</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f6; padding-bottom: 80px; }
        .search-header { background: #fff; position: sticky; top: 0; z-index: 1050; padding: 12px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .search-input { border-radius: 50px; background: #f1f3f5; border: none; height: 42px; font-weight: 500; padding-left: 45px; }
        
        .store-identity-bar { background-color: #d1e7dd; color: #0f5132; padding: 8px 15px; font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; position: sticky; top: 66px; z-index: 1045; border-bottom: 1px solid #badbcc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 50px; }
        .store-logo-sm { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; background: #fff; border: 1px solid #fff; }

        .smart-filter-bar { white-space: nowrap; overflow-x: auto; padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 66px; z-index: 1040; display: flex; gap: 8px; scrollbar-width: none; }
        .smart-filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip { display: inline-flex; align-items: center; justify-content: center; padding: 6px 16px; border-radius: 20px; background: #fff; color: #495057; border: 1px solid #e9ecef; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .filter-chip.active { background: #212529; color: white; border-color: #212529; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }

        /* Âç°ÁâáË®≠Ë®à */
        .product-card { background: #fff; border-radius: 12px; margin-bottom: 14px; border: 2.5px solid #ffb3c1; box-shadow: 0 4px 8px rgba(0,0,0,0.03); overflow: hidden; position: relative; }
        .product-card.global-king { border: 2.5px solid #ffc107; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.15); }
        .product-card.pinned-card { border: 2.5px solid #0d6efd; background: #f8fbff; }
        .product-card.diamond-king { border: 3px solid transparent; background: linear-gradient(#f8fbff, #f8fbff) padding-box, linear-gradient(135deg, #0dcaf0 0%, #0d6efd 50%, #6f42c1 100%) border-box; box-shadow: 0 0 20px rgba(13, 202, 240, 0.3); }

        .badge-float { position: absolute; top: 0; right: 0; font-weight: 800; font-size: 0.75rem; padding: 4px 12px; border-bottom-left-radius: 12px; z-index: 10; }
        .global-king-badge { background: #ffc107; color: #000; }
        .pinned-badge { background: #0d6efd; color: #fff; }
        .store-king-badge { background: #ffc107; color: #000; } 
        .diamond-badge { background: linear-gradient(135deg, #0dcaf0, #0d6efd); color: #fff; box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3); }

        .p-header { padding: 16px 16px 10px 16px; }
        .p-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .p-name { font-weight: 800; font-size: 1.15rem; color: #212529; line-height: 1.3; }
        .p-meta { font-size: 0.85rem; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .p-tag { background: #f1f3f5; padding: 3px 8px; border-radius: 6px; font-weight: 500; color: #6c757d; font-size: 0.8rem; }
        .p-category { border: 1px solid #dee2e6; color: #adb5bd; background: #fff; }
        .p-cp { color: #198754; font-weight: 700; font-size: 0.95rem; margin-left: auto; }

        .price-list { border-top: 1px solid #f8f9fa; }
        .price-row { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f8f9fa; cursor: pointer; position: relative; }
        .price-row:last-child { border-bottom: none; }
        .price-row.local-winner { background-color: #f8fbff; }
        .global-king .price-row.local-winner { background-color: #fffdf5; }
        .diamond-king .price-row.local-winner { background-color: #eefcff; }

        .chain-info { display: flex; align-items: center; gap: 8px; flex-grow: 1; min-width: 0; }
        .chain-logo { width: 28px; height: 28px; border-radius: 6px; object-fit: contain; border: 1px solid #f0f0f0; background: #fff; flex-shrink: 0;}
        .chain-name { font-weight: 700; font-size: 0.95rem; color: #343a40; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chain-arrow-icon { color: #0d6efd; font-size: 0.8rem; margin-top: 2px; margin-left: 4px; flex-shrink: 0; min-width: 16px; }
        .price-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; justify-content: center; min-width: 80px; }
        .promo-row { min-height: 18px; margin-bottom: 2px; display: flex; justify-content: flex-end; width: 100%; }
        .promo-badge { font-size: 0.7rem; background: #fff8c4; color: #b08d00; padding: 2px 6px; border-radius: 4px; font-weight: 700; display: inline-block; }
        .price-val-row { display: flex; align-items: flex-end; justify-content: flex-end; gap: 6px; height: 24px; }
        .price-current { font-weight: 800; font-size: 1.3rem; color: #212529; line-height: 1; }
        .price-current.is-cheapest { color: #dc3545; }
        .price-origin { text-decoration: line-through; color: #adb5bd; font-size: 0.8rem; font-weight: 400; margin-bottom: 3px; }
        .price-origin.placeholder { visibility: hidden; width: 32px; display: inline-block; }
        
        .store-price-box { padding: 18px 16px; display: flex; align-items: center; justify-content: space-between; background: #fff; }
        .store-price-left { display: flex; flex-direction: column; }
        .store-promo-row { min-height: 18px; margin-bottom: 2px; display: flex; justify-content: flex-start; }
        .store-price-val-row { display: flex; align-items: flex-end; justify-content: flex-start; gap: 6px; height: 24px;}
        .store-action-link { color: #0d6efd; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 4px; }

        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 15px; }
        .cat-item { text-align: center; position: relative;}
        .cat-icon { width: 50px; height: 50px; background: #fff; border-radius: 16px; margin: 0 auto 6px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.03); color: #495057; }
        .cat-text { font-size: 0.8rem; color: #6c757d; font-weight: 500; }

        .event-scroll-box { display: flex; gap: 12px; overflow-x: auto; padding: 5px 15px 15px 15px; scrollbar-width: none; }
        .event-scroll-box::-webkit-scrollbar { display: none; }
        .event-card { min-width: 260px; max-width: 260px; background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border: 1px solid #eee; position: relative; overflow: hidden; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s; }
        .event-card:active { transform: scale(0.98); }
        .event-bar { height: 6px; width: 100%; }
        .event-body { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .event-header { display: flex; align-items: center; gap: 8px; }
        .event-chain-logo { width: 20px; height: 20px; border-radius: 4px; object-fit: contain; border: 1px solid #f0f0f0; }
        .event-chain-name { font-size: 0.85rem; color: #6c757d; font-weight: 700; }
        .event-title { font-size: 1rem; font-weight: 800; color: #212529; line-height: 1.4; }
        .event-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
        .event-time { font-size: 0.75rem; color: #adb5bd; font-family: monospace; }
        .countdown-badge { font-size: 0.75rem; font-weight: 700; padding: 3px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px; }
        .bg-danger-subtle { background: #ffebeb; color: #dc3545; }
        .bg-warning-subtle { background: #fff8c4; color: #856404; }
        .bg-success-subtle { background: #d1e7dd; color: #0f5132; }

        /* ÂÖ¨Âëä */
        .notice-container { background: #fff; border-bottom: 1px solid #f0f0f0; height: 40px; overflow: hidden; position: relative; padding: 0 12px; display: flex; align-items: center; cursor: pointer; }
        .notice-container:active { background: #f8f9fa; }
        .notice-icon { color: #f59f00; margin-right: 10px; font-size: 1rem; flex-shrink: 0; }
        .notice-wrapper { flex-grow: 1; height: 100%; position: relative; overflow: hidden; }
        .notice-list { position: absolute; width: 100%; top: 0; left: 0; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .notice-item { height: 40px; display: flex; align-items: center; font-size: 0.9rem; color: #495057; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .notice-arrow { color: #adb5bd; font-size: 0.8rem; margin-left: 8px; }

        /* FAB */
        .fab-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px;
            background: linear-gradient(135deg, #0d6efd, #0043a8);
            color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
            cursor: pointer; z-index: 1060; border: none;
            transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }
        .fab-btn i { font-size: 1.4rem; }

    </style>
</head>
<body>

<div class="search-header">
    <div class="d-flex gap-2 align-items-center">
        <a href="/search" class="btn btn-light border rounded-circle shadow-sm" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <i class="bi bi-house-door-fill text-secondary"></i>
        </a>
        <div class="position-relative flex-grow-1">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
            <input type="text" id="searchInput" class="form-control search-input" 
                   placeholder="ÊâæÂï§ÈÖí (‰æã: ÈáëÁâå)" value="{{ search_keyword }}" onkeypress="handleEnter(event)">
        </div>
        <button type="button" class="btn btn-dark rounded-circle shadow-sm" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0;" onclick="performSearch()">
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</div>

<div id="store-identity-bar" class="store-identity-bar d-none"></div>
<div id="smart-filter-bar" class="smart-filter-bar d-none"></div>
<div id="main-content" class="container pt-3"></div>

<button class="fab-btn" onclick="openFeedbackModal()">
    <i class="bi bi-chat-dots-fill"></i>
</button>

<div class="modal fade" id="noticeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-megaphone-fill text-warning me-2"></i>Á≥ªÁµ±ÂÖ¨Âëä</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="noticeModalBody" class="d-flex flex-column gap-3 py-2"></div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light w-100 fw-bold" data-bs-dismiss="modal">Áü•ÈÅì‰∫Ü</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">üí¨ ÊÑèË¶ãÂõûÈ•ã</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">ÂõûÂ†±È°ûÂûã</label>
                    <select class="form-select" id="fbCategory">
                        <option value="price">üí∞ ÂÉπÊ†ºÈåØË™§ÂõûÂ†±</option>
                        <option value="wish">‚ú® Ë®±È°òÊÉ≥ÊâæÁöÑÂïÜÂìÅ</option>
                        <option value="bug">üêõ Á∂≤Á´ôÊïÖÈöú / Âª∫Ë≠∞</option>
                        <option value="contact">ü§ù ËÅØÁµ°‰ΩúËÄÖ / Âêà‰Ωú</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Ë©≥Á¥∞ÂÖßÂÆπ</label>
                    <textarea class="form-control" id="fbContent" rows="4" placeholder="Ë´ãÂëäË®¥ÊàëÂÄëÁôºÁîü‰ªÄÈ∫º‰∫ã..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ËÅØÁµ°ÊñπÂºè (ÈÅ∏Â°´)</label>
                    <input type="text" class="form-control" id="fbContact" placeholder="Email Êàñ Line ID">
                    <small class="text-muted">Ëã•ÈúÄË¶ÅÊàëÂÄëÂõûË¶ÜÊÇ®ÔºåË´ãÁïô‰∏ãËÅØÁµ°Ë≥áÊñô</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" onclick="submitFeedback()">ÈÄÅÂá∫ÂõûÂ†±</button>
            </div>
        </div>
    </div>
</div>

<script>
    const products = {{ products_data | safe if products_data else '[]' }};
    const lobbyData = {{ lobby_data | safe }};
    const currentKeyword = "{{ search_keyword }}";
    const currentMode = "{{ search_mode }}";
    const pinId = "{{ pin_id }}";
    const targetChainInfo = {{ target_chain_info | safe if target_chain_info else '{}' }};
    const myLiffId = "{{ liff_id }}"; 

    let activeFilters = { spec: null, material: null, keyword: null };
    let noticeInterval = null;

    window.onload = function() {
        initGPS();
        
        if (currentMode === 'store_shelf' && targetChainInfo.id) {
            const storeBar = document.getElementById('store-identity-bar');
            storeBar.classList.remove('d-none');
            storeBar.innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    ${targetChainInfo.logo_url ? `<img src="${targetChainInfo.logo_url}" class="store-logo-sm">` : '<i class="bi bi-shop"></i>'}
                    <span>${targetChainInfo.name}</span>
                </div>
                <button class="btn btn-sm btn-light text-primary fw-bold shadow-sm ms-auto rounded-pill px-3" 
                        onclick="openMap('${targetChainInfo.name}')">
                    <i class="bi bi-geo-alt-fill me-1"></i> Â∞éËà™
                </button>
            `;
            document.getElementById('smart-filter-bar').style.top = '112px';
        }

        const container = document.getElementById('main-content');
        if (!currentKeyword && !currentMode) renderLobby(container);
        else if (products.length > 0) { generateSmartFilters(products); renderProductCards(products, container); }
        else renderEmptyState(container);
    };

    function initGPS() {
        const urlParams = new URLSearchParams(window.location.search);
        const u_lat = urlParams.get('lat');
        const u_lng = urlParams.get('lng');
        const u_uid = urlParams.get('line_id');
        if (u_lat && u_lng) { sessionStorage.setItem('u_lat', u_lat); sessionStorage.setItem('u_lng', u_lng); }
        if (u_uid) sessionStorage.setItem('u_uid', u_uid);
    }

    function openMap(storeName) {
        const query = encodeURIComponent(storeName);
        const url = `https://www.google.com/maps/search/?api=1&query=${query}`;
        window.open(url, '_blank');
    }

    function goToUrlWithGPS(targetUrl) {
        if (!targetUrl.startsWith('http')) {
             if (!targetUrl.startsWith('/')) targetUrl = '/' + targetUrl;
             targetUrl = targetUrl.replace('/search/search', '/search');
             targetUrl = window.location.origin + targetUrl;
        }
        let separator = targetUrl.includes('?') ? '&' : '?';
        let finalUrl = targetUrl;
        const cachedLat = sessionStorage.getItem('u_lat');
        const cachedLng = sessionStorage.getItem('u_lng');
        const cachedUid = sessionStorage.getItem('u_uid');

        if (cachedLat && cachedLng) {
            finalUrl += `${separator}lat=${cachedLat}&lng=${cachedLng}`;
            if (cachedUid) finalUrl += `&line_id=${cachedUid}`;
            window.location.replace(finalUrl);
            return;
        }
        try {
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    sessionStorage.setItem('u_uid', profile.userId);
                    finalUrl += `${separator}line_id=${profile.userId}`;
                    executeRedirect(finalUrl); 
                }).catch(() => executeRedirect(finalUrl));
            } else executeRedirect(finalUrl);
        } catch (e) { executeRedirect(finalUrl); }
    }

    function executeRedirect(baseUrl) {
        if (!navigator.geolocation) { window.location.href = baseUrl; return; }
        navigator.geolocation.getCurrentPosition(
            (pos) => { 
                sessionStorage.setItem('u_lat', pos.coords.latitude);
                sessionStorage.setItem('u_lng', pos.coords.longitude);
                window.location.href = `${baseUrl}&lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`; 
            },
            (err) => { window.location.href = baseUrl; },
            { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 } 
        );
    }

    function generateSmartFilters(data) {
        const bar = document.getElementById('smart-filter-bar');
        const specs = new Set(), materials = new Set(), categories = new Set();
        data.forEach(p => { if (p.spec) specs.add(p.spec); if (p.material) materials.add(p.material); if (p.category) categories.add(p.category); });
        
        let html = `<div class="filter-chip active" onclick="resetFilters(this)">ÂÖ®ÈÉ®</div>`;
        if (categories.size > 1) categories.forEach(c => html += `<div class="filter-chip" onclick="toggleFilter('keyword', '${c}', this)">${c}</div>`);
        if (specs.size > 1) specs.forEach(s => html += `<div class="filter-chip" onclick="toggleFilter('spec', '${s}', this)">${s}</div>`);
        if (materials.size > 1) materials.forEach(m => html += `<div class="filter-chip" onclick="toggleFilter('material', '${m}', this)">${m}</div>`);

        if (categories.size > 1 || specs.size > 1 || materials.size > 1) { bar.classList.remove('d-none'); bar.innerHTML = html; }
    }
    function toggleFilter(type, val, btn) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active')); btn.classList.add('active');
        activeFilters = { spec: null, material: null, keyword: null }; activeFilters[type] = val; applyFilters();
    }
    function resetFilters(btn) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active')); btn.classList.add('active');
        activeFilters = { spec: null, material: null, keyword: null }; applyFilters();
    }
    function applyFilters() {
        const filtered = products.filter(p => {
            let pass = true;
            if (activeFilters.spec && p.spec !== activeFilters.spec) pass = false;
            if (activeFilters.material && p.material !== activeFilters.material) pass = false;
            if (activeFilters.keyword) {
                const content = (p.category + p.keywords + p.name).toLowerCase();
                if (!content.includes(activeFilters.keyword.toLowerCase())) pass = false;
            }
            return pass;
        });
        renderProductCards(filtered, document.getElementById('main-content'));
    }

    function renderProductCards(data, container) {
        if (data.length === 0) { 
            // üî• ÂëºÂè´Ê©üÂô®‰∫∫È†ÅÈù¢
            renderEmptyState(container); 
            return; 
        }

        let storeCategoryMinScores = {}; 
        let storeCategoryKingIds = {};

        if (currentMode === 'store_shelf') {
            data.forEach(p => {
                const myPrice = p.prices.find(pr => pr.is_target_store);
                if (myPrice) {
                    const cat = p.category;
                    if (!storeCategoryMinScores[cat] || p.local_score < storeCategoryMinScores[cat]) {
                        storeCategoryMinScores[cat] = p.local_score;
                        storeCategoryKingIds[cat] = p.id;
                    }
                }
            });
        }
        
        let globalKingId = null;
        if (currentMode !== 'store_shelf') {
            let minGlobalScore = 999999;
            data.forEach(p => { if (p.cp_score < minGlobalScore) { minGlobalScore = p.cp_score; globalKingId = p.id; } });
        }

        let displayData = [...data];
        if (pinId) {
            const pinnedIndex = displayData.findIndex(p => String(p.id) === String(pinId));
            if (pinnedIndex > -1) { const pinnedItem = displayData.splice(pinnedIndex, 1)[0]; displayData.unshift(pinnedItem); }
        }

        let html = '';
        displayData.forEach(p => {
            const isStoreKing = (currentMode === 'store_shelf' && storeCategoryKingIds[p.category] === p.id);
            const isGlobalKing = (currentMode !== 'store_shelf' && p.id === globalKingId);
            const isPinned = (String(p.id) === String(pinId));
            const isDiamond = isPinned && (isStoreKing || isGlobalKing);

            let cardClass = 'product-card';
            let badgeHtml = '';

            if (currentMode === 'store_shelf') {
                if (isStoreKing) {
                    const badgeText = `${p.category} CPÁéã`;
                    badgeHtml = `<div class="badge-float store-king-badge"><i class="bi bi-star-fill"></i> ${badgeText}</div>`;
                }
            } else {
                if (isGlobalKing) { cardClass += ' global-king'; badgeHtml = `<div class="badge-float global-king-badge"><i class="bi bi-trophy-fill"></i> CPÈú∏‰∏ª</div>`; }
            }
            if (isPinned) { cardClass += ' pinned-card'; badgeHtml = `<div class="badge-float pinned-badge"><i class="bi bi-check-circle-fill"></i> ÊÇ®ÈÅ∏ÊìáÁöÑ</div>`; }
            if (isDiamond) { cardClass += ' diamond-king'; badgeHtml = `<div class="badge-float diamond-badge"><i class="bi bi-gem"></i> ÊÇ®ÈÅ∏ÁöÑÂ∑≤ÊòØÈú∏‰∏ª</div>`; }

            const searchUrl = `/search?keyword=${encodeURIComponent(p.name)}`;
            let priceBody = '';
            
            if (currentMode === 'store_shelf') {
                const targetPrice = p.prices.find(pr => pr.is_target_store);
                if (targetPrice) {
                    let originHtml;
                    if (targetPrice.base_price > targetPrice.price) {
                        originHtml = `<span class="price-origin">$${targetPrice.base_price}</span>`;
                    } else {
                        originHtml = `<span class="price-origin placeholder">$00</span>`;
                    }
                    const priceColorClass = (isStoreKing || isDiamond) ? 'price-current is-cheapest' : 'price-current';
                    
                    priceBody = `
                        <div class="store-price-box" onclick="goToUrlWithGPS('${searchUrl}')">
                            <div class="store-price-left">
                                <div class="store-promo-row">
                                    ${targetPrice.promo_label ? `<span class="promo-badge">${targetPrice.promo_label}</span>` : ''}
                                </div>
                                <div class="store-price-val-row">
                                    ${originHtml} 
                                    <span class="${priceColorClass}">$${targetPrice.price}</span>
                                </div>
                            </div>
                            <div class="store-action-link">
                                ÂÖ®ÈÄöË∑ØÊØîÂÉπ <i class="bi bi-arrow-right-circle-fill" style="font-size:1.4rem;"></i>
                            </div>
                        </div>`;
                } else return;
            } else {
                if (p.prices.length > 0) {
                    const minPrice = Math.min(...p.prices.map(pr => pr.price));
                    p.prices.forEach(pr => {
                        const isLocalWinner = (pr.price === minPrice);
                        let rowClass = isLocalWinner ? 'price-row local-winner' : 'price-row';
                        const linkUrl = `/search?mode=store_shelf&chain_id=${pr.chain_id}&pin_id=${p.id}`;
                        const originHtml = (pr.base_price > pr.price) ? `<span class="price-origin">$${pr.base_price}</span>` : '';
                        let promoHtml = pr.promo_label ? `<span class="promo-badge">${pr.promo_label}</span>` : '';
                        const priceColorClass = isLocalWinner ? 'price-current is-cheapest' : 'price-current';
                        
                        priceBody += `
                            <div class="${rowClass}" onclick="goToUrlWithGPS('${linkUrl}')">
                                <div class="chain-info">
                                    ${pr.chain_logo ? `<img src="${pr.chain_logo}" class="chain-logo">` : ''}
                                    <div class="chain-name">${pr.chain_name}</div>
                                    <i class="bi bi-chevron-right chain-arrow-icon"></i>
                                </div>
                                <div class="price-right">
                                    <div class="promo-row">${promoHtml}</div>
                                    <div class="price-val-row">
                                        ${originHtml} 
                                        <span class="${priceColorClass}">$${pr.price}</span>
                                    </div>
                                </div>
                            </div>`;
                    });
                } else priceBody = `<div class="p-3 text-center text-muted small">Êö´ÁÑ°Â†±ÂÉπ</div>`;
            }

            html += `
                <div class="${cardClass}">
                    ${badgeHtml}
                    <div class="p-header">
                        <div class="p-top-row">
                            <div class="p-name" onclick="goToUrlWithGPS('${searchUrl}')">${p.name}</div>
                        </div>
                        <div class="p-meta">
                            <span class="p-tag p-category">${p.category}</span>
                            ${p.spec ? `<span class="p-tag">${p.spec}</span>` : ''}
                            ${p.material ? `<span class="p-tag">${p.material}</span>` : ''}
                            <span class="p-cp">${p.cp_display || ''}</span>
                        </div>
                    </div>
                    <div class="price-list">${priceBody}</div>
                </div>`;
        });
        container.innerHTML = html;
    }

    function renderLobby(container) {
        let noticeHtml = '';
        if (lobbyData.notices && lobbyData.notices.length > 0) {
            noticeHtml = `
                <div class="notice-container" onclick="openNoticeModal()">
                    <div class="notice-icon"><i class="bi bi-megaphone-fill"></i></div>
                    <div class="notice-wrapper">
                        <div class="notice-list" id="noticeList">
                            ${lobbyData.notices.map(n => `<div class="notice-item">${n.content}</div>`).join('')}
                        </div>
                    </div>
                    <div class="notice-arrow"><i class="bi bi-chevron-down"></i></div>
                </div>
            `;
        }

        let eventsHtml = '';
        if (lobbyData.events && lobbyData.events.length > 0) {
            eventsHtml = `
                <h6 class="px-3 text-secondary fw-bold mb-2 small mt-3">
                    <i class="bi bi-fire text-danger"></i> ÁÜ±ÈñÄÊ™îÊúü
                </h6>
                <div class="event-scroll-box">
                    ${lobbyData.events.map(e => `
                        <div class="event-card" onclick="goToUrlWithGPS('/search?mode=store_shelf&chain_id=${e.chain_id}')">
                            <div class="event-bar" style="background: ${e.bg_color || '#0d6efd'};"></div>
                            <div class="event-body">
                                <div class="event-header">
                                    <img src="${e.logo_url}" class="event-chain-logo">
                                    <span class="event-chain-name">${e.chain_name}</span>
                                </div>
                                <div class="event-title">${e.title}</div>
                                <div class="event-footer">
                                    <div class="event-time">Áõ¥Âà∞ ${e.end_date.substring(5).replace('-','/')}</div>
                                    <div class="countdown-badge bg-${e.status_color}-subtle">
                                        <i class="bi bi-clock"></i> Ââ© ${e.days_left} Â§©
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        let html = `
            ${noticeHtml}
            ${eventsHtml}

            <h6 class="px-3 text-secondary fw-bold mb-3 small ${eventsHtml ? 'mt-4' : 'mt-2'}">ÁÜ±ÈñÄÈÄöË∑Ø</h6>
            <div class="cat-grid">
                ${lobbyData.chains.map(c => `
                    <div class="cat-item" onclick="goToUrlWithGPS('/search?mode=store_shelf&chain_id=${c.id}')">
                        <div class="cat-icon">${c.logo_url ? `<img src="${c.logo_url}" style="width:30px;">` : c.icon}</div>
                        <div class="cat-text">${c.name}</div>
                    </div>`).join('')}
            </div>
            <h6 class="px-3 text-secondary fw-bold mt-4 mb-3 small">ÂïÜÂìÅÂàÜÈ°û</h6>
            <div class="cat-grid">
                ${lobbyData.categories.map(c => `
                    <div class="cat-item" onclick="goToUrlWithGPS('/search?keyword=${encodeURIComponent(c.name)}')">
                        <div class="cat-icon">${c.icon}</div>
                        <div class="cat-text">${c.name}</div>
                    </div>`).join('')}
            </div>`;
        container.innerHTML = html;

        if (lobbyData.notices && lobbyData.notices.length > 1) {
            startMarquee();
        }
    }

    function startMarquee() {
        const list = document.getElementById('noticeList');
        if (!list) return;
        const count = list.children.length;
        let index = 0;
        if (noticeInterval) clearInterval(noticeInterval);
        noticeInterval = setInterval(() => {
            index++;
            if (index >= count) index = 0;
            list.style.transform = `translateY(-${index * 40}px)`;
        }, 3000); 
    }

    function openNoticeModal() {
        if (!lobbyData.notices || lobbyData.notices.length === 0) return;
        const body = document.getElementById('noticeModalBody');
        let html = lobbyData.notices.map(n => `
            <div class="d-flex gap-2">
                <div class="mt-1 flex-shrink-0">
                    ${n.type === 'danger' ? '<i class="bi bi-exclamation-circle-fill text-danger"></i>' : 
                      n.type === 'warning' ? '<i class="bi bi-cone-striped text-warning"></i>' : 
                      '<i class="bi bi-info-circle-fill text-primary"></i>'}
                </div>
                <div class="text-dark small" style="line-height:1.5;">${n.content}</div>
            </div>
            <hr class="my-1 border-light">
        `).join('');
        body.innerHTML = html;
        new bootstrap.Modal(document.getElementById('noticeDetailModal')).show();
    }

    function openFeedbackModal() {
        document.getElementById('fbContent').value = '';
        document.getElementById('fbContact').value = '';
        document.getElementById('fbCategory').selectedIndex = 0;
        new bootstrap.Modal(document.getElementById('feedbackModal')).show();
    }

    async function submitFeedback() {
        const category = document.getElementById('fbCategory').value;
        const content = document.getElementById('fbContent').value.trim();
        const contact = document.getElementById('fbContact').value.trim();
        
        if (!content) {
            alert('Ë´ãËº∏ÂÖ•ÂõûÂ†±ÂÖßÂÆπ');
            return;
        }

        const submitBtn = document.querySelector('#feedbackModal .btn-primary');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ÂÇ≥ÈÄÅ‰∏≠...';

        let uid = sessionStorage.getItem('u_uid');
        let uname = sessionStorage.getItem('u_name');

        if (!uid || !uname) {
            try {
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    uid = profile.userId;
                    uname = profile.displayName;
                    sessionStorage.setItem('u_uid', uid);
                    sessionStorage.setItem('u_name', uname);
                }
            } catch (e) {
                console.error("LIFF Profile Error:", e);
            }
        }

        uid = uid || 'anonymous';
        uname = uname || 'Ë®™ÂÆ¢';

        fetch('/api/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                line_id: uid,
                user_name: uname,
                category: category,
                content: content,
                contact_info: contact
            })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            const modalEl = document.getElementById('feedbackModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        })
        .catch(err => {
            alert('ÂÇ≥ÈÄÅÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
            console.error(err);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }

    // üî• Ê©üÂô®‰∫∫ËàáËá™ÂãïË∑≥ËΩâ
    function renderEmptyState(container) { 
        container.innerHTML = `
            <div class="p-5 text-center">
                <div class="mb-3 text-secondary">
                    <i class="bi bi-robot" style="font-size: 4rem;"></i>
                </div>
                <h5 class="text-dark fw-bold mb-2">Êâæ‰∏çÂà∞ÂïÜÂìÅ</h5>
                <p class="text-muted small mb-4">ÂæàÊä±Ê≠âÔºåÊâæ‰∏çÂà∞ÊÇ®Ë¶ÅÁöÑÂïÜÂìÅË≥áÊñô„ÄÇ</p>
                <div class="text-muted small">
                    <span id="countdown">3</span> ÁßíÂæåËá™ÂãïËøîÂõûÂ§ßÂª≥...
                </div>
            </div>
        `;
        
        let seconds = 3;
        const timer = setInterval(() => {
            seconds--;
            const el = document.getElementById('countdown');
            if(el) el.textContent = seconds;
            
            if (seconds <= 0) {
                clearInterval(timer);
                goToUrlWithGPS('/search'); // Ë∑≥ËΩâÂõûÂ§ßÂª≥
            }
        }, 1000);
    }

    function handleEnter(event) { if (event.key === 'Enter') performSearch(); }
    
    function performSearch() {
        const input = document.getElementById('searchInput');
        if (input && input.value.trim()) {
            const target = '/search?keyword=' + encodeURIComponent(input.value.trim());
            goToUrlWithGPS(target);
        }
    }
    
    window.addEventListener('load', function() { if (typeof liff !== 'undefined') liff.init({ liffId: myLiffId }); });
</script>
</body>
</html>